# 登录问题修复说明

## 问题描述
登录时输入正确的账号密码显示错误。

## 问题原因
数据库中 `manager` 用户的密码哈希值格式不正确，缺少 BCrypt 版本标识符 `$2a`。

### BCrypt 密码格式说明
正确的 BCrypt 密码格式：`$2a$10$[盐值+哈希值]`

- `$2a` - BCrypt 版本标识符
- `$10` - 成本因子（工作因子）
- 后面的字符串 - 盐值和密码哈希值

## 错误数据
```sql
-- ❌ 错误：缺少 $2a 前缀
'$10$lqnSaaWggBoGo5BftUKuX.hmQzk3yNF4UqC5H47AeySo5KOEg6MEC'

-- ✅ 正确：完整的 BCrypt 格式
'$2a$10$lqnSaaWggBoGo5BftUKuX.hmQzk3yNF4UqC5H47AeySo5KOEg6MEC'
```

## 修复内容
已修复 `gym.sql` 文件第 656 行，将 manager 用户的密码哈希值从：
```sql
'$10$lqnSaaWggBoGo5BftUKuX.hmQzk3yNF4UqC5H47AeySo5KOEg6MEC'
```
改为：
```sql
'$2a$10$lqnSaaWggBoGo5BftUKuX.hmQzk3yNF4UqC5H47AeySo5KOEg6MEC'
```

## 解决方案

### 方案1：重新导入数据库（推荐）
```bash
# 1. 删除现有数据库
DROP DATABASE IF EXISTS gym;

# 2. 创建数据库
CREATE DATABASE gym DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 3. 重新导入修复后的 SQL 文件
USE gym;
source D:/健身房预约小程序/gym.sql;
```

### 方案2：仅更新 manager 用户密码
如果不想重新导入整个数据库，可以只执行以下 SQL 更新语句：

```sql
USE gym;

UPDATE `user` 
SET `password` = '$2a$10$lqnSaaWggBoGo5BftUKuX.hmQzk3yNF4UqC5H47AeySo5KOEg6MEC' 
WHERE `username` = 'manager';
```

## 测试账号

修复后，以下账号可正常登录：

| 用户名 | 密码 | 用户类型 | 说明 |
|--------|------|----------|------|
| admin | admin123 | ADMIN | 系统管理员 |
| manager | manager123 | ADMIN | 健身房经理 |
| pgl | (注册时设置的密码) | USER | 普通用户 |

## 验证步骤

1. **执行修复** - 选择上述方案1或方案2
2. **重启后端服务** - 确保新密码生效
3. **测试登录** - 使用以下账号测试：
   ```
   用户名: admin
   密码: admin123
   ```
   或
   ```
   用户名: manager
   密码: manager123
   ```

4. **检查响应** - 登录成功应返回：
   ```json
   {
     "code": 200,
     "msg": "登录成功",
     "data": {
       "token": "...",
       "userInfo": {
         "id": 1,
         "username": "admin",
         "userType": "ADMIN",
         ...
       }
     }
   }
   ```

## 相关代码位置

### 后端
- **密码验证逻辑**: `springboot/src/main/java/org/example/springboot/service/UserService.java` (第59行)
- **登录接口**: `springboot/src/main/java/org/example/springboot/controller/UserController.java` (第39行)
- **BCrypt加密**: Spring Security 的 `BCryptPasswordEncoder`

### 前端
- **登录页面**: `vue3/src/views/auth/Login.vue`
- **登录API**: `vue3/src/api/user.js` (login函数)

## 注意事项

1. **密码加密方式**: 本系统使用 BCrypt 算法加密密码
2. **密码验证**: `BCryptPasswordEncoder.matches(原始密码, 加密密码)`
3. **新用户注册**: 系统会自动使用 BCrypt 加密密码
4. **密码重置**: 重置密码时也会自动使用 BCrypt 加密

## 预防措施

为避免类似问题：
1. 使用系统注册接口创建用户，而非直接插入SQL
2. 如需手动插入用户，确保密码哈希值格式正确
3. 可使用在线 BCrypt 工具生成正确的密码哈希：
   - 网址: https://bcrypt-generator.com/
   - 设置 Rounds: 10
   - 输入明文密码生成哈希值

## 附录：生成新密码哈希值

如果需要为其他用户生成密码哈希值，可以：

### 方法1：使用后端代码
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String hashedPassword = encoder.encode("your_password");
System.out.println(hashedPassword);
```

### 方法2：使用在线工具
访问 https://bcrypt-generator.com/
- 输入明文密码
- Rounds 设置为 10
- 点击生成
- 复制生成的哈希值（确保以 `$2a$10$` 开头）
