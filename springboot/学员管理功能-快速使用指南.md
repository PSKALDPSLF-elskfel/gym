# 学员管理功能 - 快速使用指南

## 🚀 快速开始

### 第一步：执行数据库脚本

```sql
-- 执行建表脚本
SOURCE D:\健身房预约小程序\springboot\database\coach_student_system.sql;

-- 或者手动执行
CREATE TABLE IF NOT EXISTS `gym_coach_student` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '关系ID',
  `coach_id` bigint NOT NULL COMMENT '教练ID',
  `student_id` bigint NOT NULL COMMENT '学员用户ID',
  `remark` text COMMENT '教练备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_coach_student` (`coach_id`, `student_id`),
  KEY `idx_coach_id` (`coach_id`),
  KEY `idx_student_id` (`student_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='教练学员关系表';
```

### 第二步：准备测试数据

```sql
-- 1. 确保有教练用户
INSERT INTO user (user_type, nickname, phone, username, password, status) 
VALUES ('COACH', '李教练', '13900000001', 'coach1', '$2a$10$...', 1);

-- 2. 创建教练记录
INSERT INTO gym_coach (user_id, specialty, introduction, rating, status) 
VALUES (1, '增肌/减脂', '资深健身教练，10年经验', 4.8, 1);

-- 3. 确保有学员用户
INSERT INTO user (user_type, nickname, phone, member_type, member_expire_time, status) 
VALUES ('USER', '张三', '13800138000', 1, '2025-12-31 23:59:59', 1);

-- 4. 创建训练计划（建立教练和学员的关系）
INSERT INTO gym_training_plan (user_id, coach_id, name, goal, start_date, end_date, status) 
VALUES (2, 1, '增肌训练计划', '增肌', '2025-12-01', '2026-01-31', 1);

-- 5. 创建体测数据
INSERT INTO gym_body_test (user_id, height, weight, bmi, body_fat, muscle_mass, visceral_fat, basal_metabolism, test_time, tester_id) 
VALUES (2, 175.0, 75.5, 24.6, 18.5, 35.2, 8, 1680, '2025-12-01 14:00:00', 1);
```

### 第三步：启动后端服务

```bash
cd D:\健身房预约小程序\springboot
mvn spring-boot:run
```

### 第四步：获取教练Token

```bash
# 使用Postman或curl登录
POST http://localhost:8080/api/user/login
Content-Type: application/json

{
  "username": "coach1",
  "password": "your_password"
}

# 响应会返回token，保存此token用于后续请求
```

---

## 📡 API调用示例

### 1. 查询我的学员列表

```bash
curl -X GET "http://localhost:8080/api/coach/students/my?pageNum=1&pageSize=10" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [
      {
        "userId": 2,
        "nickname": "张三",
        "phone": "13800138000",
        "memberType": 1,
        "memberTypeName": "黄金会员",
        "trainingPlanCount": 1
      }
    ],
    "total": 1
  }
}
```

### 2. 查看学员详情

```bash
curl -X GET "http://localhost:8080/api/coach/students/2/detail" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

### 3. 添加学员备注

```bash
curl -X PUT "http://localhost:8080/api/coach/students/remark" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 2,
    "remark": "训练态度积极，建议增加力量训练强度"
  }'
```

---

## 🔍 常见场景

### 场景1：搜索学员

```bash
# 按昵称搜索
GET /api/coach/students/my?keyword=张三

# 按手机号搜索
GET /api/coach/students/my?keyword=138

# 筛选会员类型
GET /api/coach/students/my?memberType=1  # 黄金会员
```

### 场景2：查看学员训练进度

```bash
# 1. 获取学员详情
GET /api/coach/students/2/detail

# 2. 查看训练计划列表
GET /api/coach/students/2/training-plans

# 3. 查看体测历史
GET /api/coach/students/2/body-tests
```

### 场景3：批量查看学员

```bash
# 第一页
GET /api/coach/students/my?pageNum=1&pageSize=10

# 第二页
GET /api/coach/students/my?pageNum=2&pageSize=10
```

---

## 🐛 故障排查

### 问题1：返回"当前用户不是教练"

**检查步骤**:
```sql
-- 1. 检查用户类型
SELECT user_type FROM user WHERE id = {userId};

-- 2. 检查gym_coach表
SELECT * FROM gym_coach WHERE user_id = {userId};
```

**解决方案**:
```sql
-- 如果没有教练记录，创建一个
INSERT INTO gym_coach (user_id, specialty, status) 
VALUES ({userId}, '综合', 1);
```

### 问题2：学员列表为空

**检查步骤**:
```sql
-- 检查是否有训练计划
SELECT * FROM gym_training_plan WHERE coach_id = {coachId};
```

**解决方案**:
```sql
-- 为学员创建训练计划
INSERT INTO gym_training_plan (user_id, coach_id, name, goal, start_date, end_date, status) 
VALUES ({studentUserId}, {coachId}, '训练计划', '增肌', CURDATE(), DATE_ADD(CURDATE(), INTERVAL 30 DAY), 1);
```

### 问题3：无权查看学员信息

**原因**: 该学员没有该教练创建的训练计划

**解决方案**: 先为学员创建训练计划

---

## 📊 数据验证

### 验证学员数据完整性

```sql
-- 查询学员基本信息
SELECT 
    u.id,
    u.nickname,
    u.phone,
    u.member_type,
    u.member_expire_time,
    COUNT(tp.id) as plan_count,
    cs.remark as coach_remark
FROM user u
LEFT JOIN gym_training_plan tp ON u.id = tp.user_id AND tp.coach_id = {coachId}
LEFT JOIN gym_coach_student cs ON u.id = cs.student_id AND cs.coach_id = {coachId}
WHERE u.user_type = 'USER'
GROUP BY u.id;
```

### 验证体测数据

```sql
-- 查询学员体测历史
SELECT * FROM gym_body_test 
WHERE user_id = {studentUserId}
ORDER BY test_time DESC;
```

---

## 🎯 使用技巧

### 技巧1：快速筛选活跃学员

```bash
# 筛选黄金会员和铂金会员
GET /api/coach/students/my?memberType=1  # 黄金
GET /api/coach/students/my?memberType=2  # 铂金
```

### 技巧2：模糊搜索

```bash
# 搜索关键词会同时匹配昵称和手机号
GET /api/coach/students/my?keyword=张
```

### 技巧3：数据导出

```javascript
// 前端代码示例
async function exportStudents() {
  let allStudents = [];
  let pageNum = 1;
  const pageSize = 100;
  
  while (true) {
    const res = await fetch(`/api/coach/students/my?pageNum=${pageNum}&pageSize=${pageSize}`);
    const data = await res.json();
    
    allStudents.push(...data.data.records);
    
    if (pageNum >= data.data.pages) break;
    pageNum++;
  }
  
  // 导出Excel
  exportToExcel(allStudents);
}
```

---

## 📱 前端集成示例

### Vue3示例

```vue
<template>
  <div class="student-list">
    <el-input 
      v-model="searchKeyword" 
      placeholder="搜索学员昵称或手机号"
      @change="loadStudents"
    />
    
    <el-select v-model="memberType" @change="loadStudents">
      <el-option label="全部会员" :value="null" />
      <el-option label="普通用户" :value="0" />
      <el-option label="黄金会员" :value="1" />
      <el-option label="铂金会员" :value="2" />
    </el-select>
    
    <el-table :data="students" @row-click="viewDetail">
      <el-table-column prop="nickname" label="昵称" />
      <el-table-column prop="phone" label="手机号" />
      <el-table-column prop="memberTypeName" label="会员类型" />
      <el-table-column prop="trainingPlanCount" label="训练计划" />
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button @click="editRemark(row)">备注</el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <el-pagination
      v-model:current-page="currentPage"
      :page-size="pageSize"
      :total="total"
      @current-change="loadStudents"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getMyStudents } from '@/api/coach';

const students = ref([]);
const currentPage = ref(1);
const pageSize = ref(10);
const total = ref(0);
const searchKeyword = ref('');
const memberType = ref(null);

const loadStudents = async () => {
  const res = await getMyStudents({
    keyword: searchKeyword.value,
    memberType: memberType.value,
    pageNum: currentPage.value,
    pageSize: pageSize.value
  });
  
  students.value = res.data.records;
  total.value = res.data.total;
};

onMounted(() => {
  loadStudents();
});
</script>
```

---

## ✅ 验证清单

使用此清单确保功能正常：

- [ ] 数据库表创建成功
- [ ] 教练记录存在
- [ ] 学员数据存在
- [ ] 训练计划关联正确
- [ ] 可以获取教练Token
- [ ] 学员列表查询成功
- [ ] 分页功能正常
- [ ] 搜索功能正常
- [ ] 筛选功能正常
- [ ] 学员详情查询成功
- [ ] 备注更新成功
- [ ] 体测历史查询成功
- [ ] 训练计划查询成功
- [ ] 权限验证正常

---

## 📞 技术支持

如遇到问题，请检查：

1. 数据库连接是否正常
2. 表结构是否正确
3. 测试数据是否完整
4. Token是否有效
5. 日志文件中的错误信息

详细的API文档请参考：`API测试文档-学员管理.md`

---

**文档版本**: v1.0  
**更新时间**: 2025-12-11
