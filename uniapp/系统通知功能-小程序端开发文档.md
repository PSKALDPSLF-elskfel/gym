# 系统通知功能 - 小程序端开发文档

## 📱 功能概述

系统通知功能为用户提供了完善的消息接收和管理能力，包括:
- ✅ 查看系统通知列表
- ✅ 未读/已读通知筛选
- ✅ 通知详情查看
- ✅ 标记已读功能
- ✅ 删除通知功能
- ✅ 全部标记已读
- ✅ 未读数量角标显示
- ✅ 下拉刷新和上拉加载更多
- ✅ 跳转到相关业务页面

## 📁 文件结构

```
uniapp/
├── apis/
│   └── notification.js              # 通知API接口
├── pages/
│   ├── notification/
│   │   └── list.vue                 # 通知列表页面
│   └── my/
│       └── my.vue                   # 我的页面(添加通知入口)
└── pages.json                        # 页面配置(添加通知路由)
```

## 🔧 开发内容

### 1. API接口封装 (notification.js)

创建了5个API方法:

```javascript
// 获取我的通知列表
getMyNotifications(params, config)

// 获取未读通知数量
getUnreadCount(config)

// 标记通知为已读
markAsRead(notificationId, config)

// 全部标记为已读
markAllAsRead(config)

// 删除通知
deleteNotification(notificationId, config)
```

### 2. 通知列表页面 (list.vue)

#### 核心功能实现:

**1. 通知列表展示**
- 分页加载通知数据
- 支持下拉刷新
- 支持上拉加载更多
- 未读通知高亮显示(浅橙色背景)
- 显示未读标记(红点)

**2. 筛选功能**
- 全部通知
- 仅显示未读
- 仅显示已读

**3. 通知详情**
- 点击通知项弹出详情弹窗
- 显示完整的通知内容
- 支持跳转到相关业务页面

**4. 操作功能**
- 单个通知标记已读
- 全部通知标记已读
- 删除单个通知
- 删除时二次确认

**5. 时间格式化**
- 1分钟内显示"刚刚"
- 1小时内显示"X分钟前"
- 今天显示"今天 HH:MM"
- 昨天显示"昨天 HH:MM"
- 更早显示"M月D日"

#### 数据结构:

```javascript
{
  id: number,                    // 通知ID
  notificationType: string,      // 通知类型
  notificationTypeDesc: string,  // 通知类型描述
  title: string,                 // 通知标题
  content: string,               // 通知内容
  icon: string,                  // 通知图标URL
  priority: number,              // 优先级(0-低,1-中,2-高)
  relatedId: string,            // 关联业务ID
  relatedType: string,          // 关联业务类型
  sendTime: string,             // 发送时间
  isRead: boolean,              // 是否已读
  readTime: string              // 读取时间
}
```

### 3. 我的页面改造 (my.vue)

**添加的功能:**
1. 系统通知菜单项
2. 未读数量角标显示
3. 页面加载时获取未读数量
4. 点击跳转到通知列表页

**UI变化:**
```vue
<view class="menu-item" @click="goToNotifications">
  <view class="menu-left">
    <text class="fa fa-bell menu-icon"></text>
    <text class="menu-text">系统通知</text>
  </view>
  <view class="menu-right">
    <view v-if="unreadCount > 0" class="badge">
      {{ unreadCount > 99 ? '99+' : unreadCount }}
    </view>
    <text class="fa fa-chevron-right menu-arrow"></text>
  </view>
</view>
```

### 4. 路由配置 (pages.json)

添加通知页面路由:

```json
{
  "path": "pages/notification/list",
  "style": {
    "navigationBarTitleText": "系统通知",
    "navigationStyle": "custom"
  }
}
```

## 🎨 UI设计特点

### 1. 通知列表项设计
- **未读通知**: 浅橙色背景 + 红色标记点
- **已读通知**: 白色背景
- **高优先级**: 显示"重要"红色角标
- **圆角卡片**: 16rpx圆角 + 轻微阴影

### 2. 通知图标
- 如果有自定义图标,显示图标图片
- 否则显示彩色渐变背景的文字图标
- 根据通知类型显示不同文字(系统/预约/课程/器材/会员)

### 3. 筛选标签
- 激活标签: 橙色文字 + 底部下划线
- 未激活标签: 灰色文字

### 4. 详情弹窗
- 从底部弹出
- 最大高度80vh
- 支持滚动查看完整内容
- 底部按钮可跳转到相关页面

### 5. 未读角标
- 红色圆形背景
- 数量超过99显示"99+"
- 显示在菜单项右侧

## 📲 使用流程

### 用户视角流程:

1. **进入通知页面**
   - 从"我的"页面点击"系统通知"
   - 或从其他页面直接跳转

2. **查看通知列表**
   - 默认显示所有通知
   - 可切换筛选:全部/未读/已读
   - 未读通知有高亮和红点标记

3. **查看通知详情**
   - 点击通知项
   - 弹出详情弹窗
   - 自动标记为已读

4. **跳转相关页面**
   - 点击"查看详情"按钮
   - 根据业务类型跳转:
     - COURSE_BOOKING → 预约详情
     - COURSE → 课程详情
     - EQUIPMENT → 器材详情

5. **管理通知**
   - 删除单个通知(长按或点击删除按钮)
   - 全部标记已读

## 🔄 业务流程集成

### 后端触发通知发送:

```java
// 示例:课程预约成功后发送通知
@Service
public class CourseBookingService {
    @Resource
    private NotificationService notificationService;
    
    public void createBooking(Long userId, Long scheduleId) {
        // 创建预约...
        
        // 发送通知
        NotificationCreateDTO notification = NotificationCreateDTO.builder()
            .notificationType("BOOKING")
            .title("课程预约成功")
            .content("您已成功预约瑜伽课程,上课时间:2025-12-15 15:00")
            .targetUserId(userId)
            .relatedId(bookingId.toString())
            .relatedType("COURSE_BOOKING")
            .priority(1)
            .build();
        notificationService.sendNotification(notification);
    }
}
```

### 小程序端接收:

1. 用户打开小程序
2. 进入"我的"页面,看到未读角标
3. 点击"系统通知"查看消息
4. 点击通知查看详情
5. 点击"查看详情"跳转到预约详情页

## 📊 数据流转

```
后端发送通知
    ↓
数据库记录
    ↓
小程序调用API获取
    ↓
展示通知列表
    ↓
用户点击通知
    ↓
标记已读(调用API)
    ↓
更新未读数量
```

## 🧪 测试要点

### 功能测试:
- [ ] 通知列表正确加载
- [ ] 分页功能正常
- [ ] 下拉刷新有效
- [ ] 上拉加载更多正常
- [ ] 筛选功能准确
- [ ] 未读通知高亮显示
- [ ] 点击通知标记为已读
- [ ] 全部标记已读功能
- [ ] 删除通知功能
- [ ] 跳转到相关页面正确

### UI测试:
- [ ] 未读角标正确显示
- [ ] 时间格式化正确
- [ ] 通知图标显示正常
- [ ] 详情弹窗样式正确
- [ ] 空状态显示正确

### 性能测试:
- [ ] 列表滚动流畅
- [ ] 大量通知时性能良好
- [ ] API响应时间合理

### 兼容性测试:
- [ ] 在不同机型上显示正常
- [ ] 在微信开发者工具中正常
- [ ] 在真机上运行正常

## 🚀 优化建议

### 1. 性能优化
- 虚拟列表(通知数量超过100条时)
- 图片懒加载
- 本地缓存未读数量

### 2. 用户体验优化
- 添加骨架屏loading效果
- 添加滑动删除手势
- 通知分组显示(按日期)
- 支持通知搜索

### 3. 功能扩展
- 通知提醒音效
- 通知震动反馈
- 支持富文本内容
- 支持通知附件

### 4. 数据统计
- 通知打开率统计
- 用户行为分析
- 通知效果评估

## 🐛 常见问题

### 1. 未读数量不更新?
**解决方案**: 
- 检查API调用是否成功
- 确认后端返回数据正确
- 检查页面onShow生命周期

### 2. 图标不显示?
**解决方案**:
- 检查图标URL是否正确
- 确认文件路径可访问
- 使用默认图标兜底

### 3. 跳转失败?
**解决方案**:
- 检查relatedType和relatedId
- 确认目标页面路由配置正确
- 添加错误处理提示

### 4. 列表加载慢?
**解决方案**:
- 减少每页数据量
- 优化API响应时间
- 添加缓存机制

## 📝 开发完成清单

- ✅ API接口封装
- ✅ 通知列表页面
- ✅ 筛选功能
- ✅ 详情弹窗
- ✅ 标记已读功能
- ✅ 删除功能
- ✅ 我的页面入口
- ✅ 未读角标显示
- ✅ 路由配置
- ✅ 样式美化
- ✅ 时间格式化
- ✅ 跳转相关页面
- ✅ 下拉刷新
- ✅ 上拉加载

## 📅 后续工作

1. ⏳ 添加通知提醒音效
2. ⏳ 集成到各业务模块
3. ⏳ 完善错误处理
4. ⏳ 性能优化
5. ⏳ 真机测试

---

**开发完成时间**: 2025-12-11  
**开发者**: System  
**版本**: v1.0  
**小程序端通知功能开发完成!** 🎉
