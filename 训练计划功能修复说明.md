# 训练计划功能错误修复说明

## 问题概述

用户在使用训练计划模板选择功能时遇到以下错误：

### 1. 后端错误
```
No endpoint GET /api/training-plan-templates/page
```

### 2. 前端错误
```javascript
TypeError: Cannot read property 'close' of undefined
    at Proxy.closeDetail (template-select.vue:312)
```

---

## 问题分析

### 后端问题

**根本原因**：训练计划模板查询接口未在 Spring Security 的公开访问路径列表中配置。

**影响**：
- `/api/training-plan-templates/page` 接口需要认证
- 前端请求时被 Spring Security 拦截
- 返回 500 错误而不是正常数据

### 前端问题

**根本原因**：项目未安装 `uni-popup` 组件，但代码中使用了该组件。

**影响**：
- `this.$refs.detailPopup` 为 `undefined`
- 调用 `.close()` 方法时报错
- 页面功能异常

---

## 解决方案

### 1. 后端修复

**文件**：`springboot/src/main/java/org/example/springboot/config/SecurityConfig.java`

**修改内容**：在 `PUBLIC_PATHS` 数组中添加训练计划模板查询接口

```java
private static final String[] PUBLIC_PATHS = {
    // ... 其他路径
    
    // 训练计划模板查询接口(公开访问，用户浏览模板)
    "/api/training-plan-templates/page",   // 模板列表查询
    "/api/training-plan-templates/{id}",   // 模板详情查询
    
    // ... 其他路径
};
```

**原因说明**：
- 训练计划模板是系统公开资源，用户应该可以在未登录状态下浏览
- 只有创建计划的接口需要认证（已通过 JWT 过滤器处理）

### 2. 前端修复

**文件**：`uniapp/pages/training-plan/template-select.vue`

#### 2.1 移除 uni-popup 依赖

**原始代码**（使用 uni-popup）:
```vue
<uni-popup ref="detailPopup" type="bottom">
  <view class="popup-container">
    <!-- 内容 -->
  </view>
</uni-popup>
```

**修改后**（使用原生实现）:
```vue
<view class="popup-mask" v-if="showDetailPopup" @click="closeDetail">
  <view class="popup-container" @click.stop>
    <!-- 内容 -->
  </view>
</view>
```

#### 2.2 添加弹窗状态控制

```javascript
data() {
  return {
    // ... 其他数据
    showDetailPopup: false,  // 详情弹窗显示状态
    showNamePopup: false,    // 名称输入弹窗显示状态
  }
}
```

#### 2.3 修改弹窗控制方法

**原始代码**:
```javascript
closeDetail() {
  this.$refs.detailPopup.close()
}
```

**修改后**:
```javascript
closeDetail() {
  this.showDetailPopup = false
}
```

#### 2.4 添加遮罩层样式

```css
/* 弹窗遮罩层 */
.popup-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  z-index: 999;
}
```

---

## 修复效果

### 后端接口

✅ `/api/training-plan-templates/page` 可以无需登录访问  
✅ `/api/training-plan-templates/{id}` 可以无需登录访问  
✅ 返回正确的模板数据  

### 前端页面

✅ 模板列表正常加载  
✅ 点击模板可以查看详情  
✅ 详情弹窗正常显示和关闭  
✅ 创建计划弹窗正常显示和关闭  
✅ 所有交互功能正常  

---

## 测试步骤

### 1. 启动后端服务

```bash
cd springboot
mvn spring-boot:run
```

### 2. 启动前端（微信小程序）

```bash
cd uniapp
# 使用 HBuilderX 或其他工具运行到微信开发者工具
```

### 3. 测试功能

1. **打开模板选择页面**
   - 路径：`/pages/training-plan/template-select`
   - 预期：显示模板列表

2. **筛选模板**
   - 选择训练目标（减脂/增肌/塑形/康复）
   - 选择难度（初级/中级/高级）
   - 预期：列表更新显示符合条件的模板

3. **查看模板详情**
   - 点击任意模板卡片
   - 预期：弹出详情弹窗，显示模板信息和训练动作

4. **创建训练计划**
   - 在详情弹窗点击"使用此模板创建计划"
   - 输入计划名称
   - 点击确定
   - 预期：创建成功并跳转到计划详情页

---

## 技术要点

### 1. Spring Security 路径配置

- **公开路径**：不需要认证即可访问
- **受保护路径**：需要 JWT 认证才能访问
- 合理配置可以提升用户体验（减少不必要的登录要求）

### 2. 组件依赖管理

- 使用第三方组件前需确认已安装
- 可选方案：
  - 方案 A：安装缺失的组件
  - 方案 B：使用原生实现替代（本次采用）

### 3. 弹窗实现方式

**uni-popup 方式**（需要安装插件）:
```javascript
this.$refs.popup.open()
this.$refs.popup.close()
```

**原生方式**（本次实现）:
```javascript
// 控制显示/隐藏
this.showPopup = true
this.showPopup = false
```

---

## 相关文件清单

### 修改的文件

1. **后端**
   - `springboot/src/main/java/org/example/springboot/config/SecurityConfig.java`

2. **前端**
   - `uniapp/pages/training-plan/template-select.vue`

### 未修改的文件

- `springboot/src/main/java/org/example/springboot/controller/TrainingPlanTemplateController.java` （接口定义正确）
- `springboot/src/main/java/org/example/springboot/service/TrainingPlanService.java` （业务逻辑正常）
- `uniapp/apis/trainingPlan.js` （API 调用正确）

---

## 注意事项

1. **认证策略**
   - 模板查询接口已设为公开，任何人都可以浏览
   - 创建计划接口仍需要登录认证
   - 确保这符合业务需求

2. **弹窗实现**
   - 使用原生方式实现弹窗
   - 如需更丰富的弹窗功能，可以考虑安装 `uni-popup` 插件

3. **后续优化**
   - 可以考虑添加模板缓存机制
   - 可以添加模板收藏功能
   - 可以添加模板推荐算法

---

## 总结

本次修复解决了训练计划模板功能的两个主要问题：

1. **后端权限配置问题** - 通过在 Spring Security 中添加公开路径配置
2. **前端组件依赖问题** - 通过原生实现替代 uni-popup 组件

修复后，用户可以正常浏览训练计划模板并创建自己的训练计划。
