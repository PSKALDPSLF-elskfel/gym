# 系统通知 - 快速故障排查

## 🚨 问题现象

```
业务错误 [5]: {code: "500", msg: "No static resource api/notifications/unread/count."}
获取未读数量失败: {type: "business", code: "500", message: "No static resource api/notifications/unread/count."}
```

---

## 🔍 问题原因分析

### 错误信息含义
- **"No static resource"** = 小程序将请求当作了静态资源请求
- 这通常表示API请求地址配置错误或后端服务未启动

### 可能的原因
1. ❌ **后端服务没有启动** (最常见)
2. ❌ **端口号配置错误** (8888 vs 8080)
3. ❌ **网络连接问题**
4. ❌ **没有登录token**

---

## ✅ 一键修复 (5分钟)

### Step 1: 启动后端服务

**Windows PowerShell:**
```powershell
cd "D:\健身房预约小程序\springboot"
mvn spring-boot:run
```

**或使用IDE:**
- 打开 `springboot/src/main/java/org/example/springboot/SpringbootApplication.java`
- 右键 -> Run 'SpringbootApplication.main()'

**验证启动成功:**
```
查看控制台日志，应该看到:
✅ Tomcat started on port(s): 8080
✅ Started SpringbootApplication in X.XXX seconds
```

### Step 2: 检查端口号配置

**小程序配置文件:** `uniapp/utils/request.js`

确保 `baseURL` 设置为:
```javascript
baseURL: 'http://localhost:8080/api'  // ✅ 正确
// 不要用 8888 或其他端口
```

### Step 3: 重启小程序

**微信开发者工具:**
1. 关闭当前预览/编译
2. Ctrl+R 重新编译
3. 进入"我的"页面
4. 点击"系统通知"

### Step 4: 使用API诊断工具

如果仍有问题，使用内置的诊断工具:
1. 打开"我的"页面
2. **滚动到底部**，找到"🔧 API诊断"菜单项
3. 点击进入诊断页面
4. 点击各个测试按钮进行逐步诊断

---

## 📊 API诊断工具使用指南

### 测试步骤

**①️⃣ 后端健康检查**
```
按钮: 1️⃣ 后端健康检查
预期结果:
✅ HTTP状态码: 200
✅ 后端服务正常运行！
```

如果失败：
- ❌ 连接失败：后端未启动，按 Step 1 启动
- ❌ 超时：检查 localhost:8080 是否可访问

**②️⃣ 获取当前用户**
```
前置条件: 需要先登录！
按钮: 2️⃣ 获取当前用户
预期结果:
✅ 获取用户成功: {用户名}
```

如果失败：
- ❌ 未登录：先登录，然后重试
- ❌ Token无效：登出再登入

**③️⃣ 获取未读通知数量**
```
前置条件: 需要先登录！
按钮: 3️⃣ 获取未读通知数量
预期结果:
✅ 获取成功: 未读通知X条
```

这是最关键的测试！如果此步骤通过，说明问题已解决。

**④️⃣ 获取通知列表**
```
前置条件: 需要先登录！
按钮: 4️⃣ 获取通知列表
预期结果:
✅ 获取成功: 共X条通知
✅ 当前返回Y条记录
```

---

## 🔧 终极调试指南

### 查看完整请求URL

打开**微信开发者工具 -> 网络 tab**:

```
预期看到的请求:
GET http://localhost:8080/api/notifications/unread/count
Headers:
  - Authorization: Bearer {token}...
  - Content-Type: application/json;charset=utf-8

响应:
{
  "code": "200",
  "message": "操作成功",
  "data": 5
}
```

### 控制台日志检查

打开**微信开发者工具 -> 控制台 tab**，应该看到:

```javascript
🌐 API Base URL: http://localhost:8080/api
📍 Full URL: http://localhost:8080/api/notifications/unread/count
📤 发送请求 [1]: { method: 'GET', url: '/notifications/unread/count' }
📥 收到响应 [1]: { method: 'GET', code: '200', time: '125ms', statusCode: 200 }
```

---

## 📝 常见问题速查表

| 症状 | 原因 | 解决方案 |
|------|------|--------|
| 连接超时 | 后端未启动 | 运行 `mvn spring-boot:run` |
| 404错误 | 端口号错误 | 改为 `http://localhost:8080/api` |
| 401错误 | 没有登录 | 先登录获取token |
| 500错误 | API不存在 | 检查后端Controller是否存在该路由 |
| 无响应 | 网络问题 | 检查localhost能否访问 |

---

## 🚀 验证修复成功的标志

当你看到以下现象时，说明问题已完全解决:

✅ **信号1:** 控制台看到正确的日志
```
🌐 API Base URL: http://localhost:8080/api
📍 Full URL: http://localhost:8080/api/notifications/unread/count
```

✅ **信号2:** 通知页面正常加载
```
- 通知列表显示内容
- 未读角标显示数字
- 可以筛选、查看、标记已读
```

✅ **信号3:** 网络请求返回200
```
开发者工具 -> 网络 tab
所有api请求状态码都是200
响应数据正确显示
```

---

## 📞 如果仍未解决

1. **检查后端日志**
   ```
   查看SpringBoot启动日志是否有错误
   ```

2. **验证数据库连接**
   ```sql
   -- MySQL中检查表是否存在
   SELECT COUNT(*) FROM sys_notification;
   SELECT COUNT(*) FROM sys_notification_read;
   ```

3. **导入测试数据**
   ```bash
   # 运行以下SQL添加测试数据
   mysql -u root -p gym < springboot/notification_test_data.sql
   ```

4. **查看完整堆栈错误**
   ```javascript
   // 在notification.js中添加详细日志
   console.log('完整错误响应:', JSON.stringify(error, null, 2))
   ```

---

## 💡 核心要点

| 项目 | 配置值 | 位置 |
|------|--------|------|
| 后端端口 | **8080** | `springboot/src/main/resources/application.yml` |
| 小程序API地址 | **http://localhost:8080/api** | `uniapp/utils/request.js` |
| 诊断工具入口 | 我的 -> 🔧 API诊断 | `pages/debug/api-test.vue` |
| 配置文档 | 详细指南 | `系统通知-配置和问题排查指南.md` |

---

## 🎯 最后检查清单

在将应用部署到真机前，确保检查以下项:

- [ ] 后端服务已启动 (端口8080)
- [ ] 小程序API地址配置为 `http://localhost:8080/api`
- [ ] 已使用API诊断工具验证所有接口
- [ ] 数据库已初始化 (sys_notification表存在)
- [ ] 能成功登录并获取token
- [ ] 能正常显示未读通知数量
- [ ] 能正常加载通知列表

---

**问题解决后，删除诊断菜单项（可选）:**

在 `uniapp/pages/my/my.vue` 中删除API诊断菜单代码即可。

---

**最后更新:** 2025-12-11  
**版本:** v2.0
