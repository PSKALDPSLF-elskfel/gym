# 训练计划小程序端开发文档

## 📋 文档说明
- **功能模块**: 训练计划小程序端
- **开发日期**: 2025-12-11
- **开发状态**: ✅ 已完成
- **技术栈**: Spring Boot + UniApp

---

## 🎯 功能概述

训练计划小程序端为用户提供完整的训练计划管理功能，包括：
- 查询我的训练计划列表
- 查看训练计划详情（每日训练内容）
- 标记训练项目完成状态
- 添加训练感受和备注
- 查看历史训练记录
- 训练计划进度可视化

---

## 🗄️ 数据库扩展

### 扩展的字段

在 `gym_training_plan_detail` 表中添加了以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| execution_note | TEXT | 执行备注（训练感受） |
| actual_sets | INT | 实际完成组数 |
| actual_reps | INT | 实际完成次数 |

### 迁移脚本

执行以下SQL脚本完成数据库扩展：

```bash
mysql -u root -p gym_booking_system < springboot/database/training_plan_detail_extension.sql
```

脚本位置: `springboot/database/training_plan_detail_extension.sql`

---

## 🔧 后端开发

### 1. 实体类扩展

**文件**: `springboot/src/main/java/org/example/springboot/entity/GymTrainingPlanDetail.java`

新增字段：
```java
@Schema(description = "执行备注")
@TableField("execution_note")
private String executionNote;

@Schema(description = "实际完成组数")
@TableField("actual_sets")
private Integer actualSets;

@Schema(description = "实际完成次数")
@TableField("actual_reps")
private Integer actualReps;
```

### 2. DTO扩展

**文件**: `springboot/src/main/java/org/example/springboot/dto/response/TrainingPlanDetailResponseDTO.java`

同步添加对应的响应字段。

### 3. Service层新增方法

**文件**: `springboot/src/main/java/org/example/springboot/service/TrainingPlanService.java`

新增方法：

#### 3.1 更新训练明细完成状态
```java
public void updateDetailCompletion(Long detailId, Integer isCompleted, 
    Integer actualSets, Integer actualReps, String executionNote)
```

#### 3.2 添加执行备注
```java
public void addExecutionNote(Long detailId, String note)
```

#### 3.3 获取执行历史
```java
public List<TrainingPlanDetailResponseDTO> getExecutionHistory(Long userId, int limit)
```

#### 3.4 计算计划进度
```java
public Double calculateProgress(Long planId)
```

### 4. Controller层新增接口

**文件**: `springboot/src/main/java/org/example/springboot/controller/TrainingPlanController.java`

新增接口：

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 更新训练明细完成状态 | PUT | /api/training-plans/detail/{detailId}/completion | 标记训练项目完成 |
| 添加执行备注 | POST | /api/training-plans/detail/{detailId}/note | 添加训练感受 |
| 获取执行历史 | GET | /api/training-plans/execution-history | 查询训练历史 |
| 计算计划进度 | GET | /api/training-plans/{id}/progress | 获取完成进度 |

---

## 📱 小程序端开发

### 1. API封装

**文件**: `uniapp/apis/trainingPlan.js`

封装的API方法：

#### 1.1 训练计划管理
- `getTrainingPlanPage()` - 分页查询训练计划列表
- `getTrainingPlanById()` - 获取训练计划详情
- `createTrainingPlan()` - 创建训练计划
- `updateTrainingPlan()` - 更新训练计划
- `deleteTrainingPlan()` - 删除训练计划

#### 1.2 训练明细管理
- `updateDetailCompletion()` - 更新训练明细完成状态
- `addExecutionNote()` - 添加执行备注
- `getExecutionHistory()` - 获取执行历史
- `calculateProgress()` - 计算计划进度

### 2. 页面开发

#### 2.1 训练计划列表 (list.vue)

**路径**: `uniapp/pages/training-plan/list.vue`

**功能**:
- 显示用户的所有训练计划
- 状态筛选（全部/进行中/已结束）
- 显示每个计划的完成进度
- 点击跳转到详情页

**主要组件**:
```vue
<template>
  <!-- 状态筛选标签页 -->
  <view class="status-tabs">...</view>
  
  <!-- 训练计划列表 -->
  <view class="plan-list">
    <view class="plan-card">
      <!-- 计划基本信息 -->
      <!-- 进度条 -->
    </view>
  </view>
</template>
```

#### 2.2 训练计划详情 (detail.vue)

**路径**: `uniapp/pages/training-plan/detail.vue`

**功能**:
- 显示计划基本信息
- 显示完成进度（百分比和进度条）
- 按星期显示每日训练安排
- 标记训练项目完成状态
- 记录实际完成情况（组数、次数）
- 添加训练感受
- 查看已完成项目的详细信息

**核心功能**:
1. **标记完成**: 点击按钮弹出表单，填写实际完成数据和感受
2. **取消完成**: 已完成的项目可以取消标记
3. **进度实时更新**: 标记完成后自动刷新进度

**交互流程**:
```
用户点击"标记完成" 
  ↓
弹出完成表单
  ↓
填写实际组数、次数、训练感受
  ↓
提交 → 调用API更新状态
  ↓
刷新页面显示最新进度
```

#### 2.3 训练历史 (history.vue)

**路径**: `uniapp/pages/training-plan/history.vue`

**功能**:
- 显示用户的所有训练完成记录
- 按时间倒序排列
- 显示动作名称、完成参数、训练感受
- 支持查看最近50条记录

**数据展示**:
```
动作名称         完成时间
├─ 实际组数: X组
├─ 实际次数: X次
├─ 重量: Xkg
└─ 训练感受: XXX
```

### 3. 路由配置

**文件**: `uniapp/pages.json`

添加的页面路由：
```json
{
  "path": "pages/training-plan/list",
  "style": {
    "navigationBarTitleText": "我的训练计划",
    "navigationStyle": "custom"
  }
},
{
  "path": "pages/training-plan/detail",
  "style": {
    "navigationBarTitleText": "计划详情",
    "navigationStyle": "custom"
  }
},
{
  "path": "pages/training-plan/history",
  "style": {
    "navigationBarTitleText": "训练历史",
    "navigationStyle": "custom"
  }
}
```

---

## 🎨 UI设计

### 设计规范

#### 颜色方案
- 主色调: `#3b82f6` (蓝色)
- 成功色: `#10b981` (绿色)
- 警告色: `#f59e0b` (橙色)
- 背景色: `#f5f5f5` (浅灰)

#### 组件样式
1. **计划卡片**: 白色背景、圆角、阴影效果
2. **进度条**: 渐变色填充、动画过渡
3. **状态标签**: 不同状态使用不同颜色
4. **完成标记**: 绿色对勾、灰色圆圈

#### 交互设计
- 点击卡片跳转详情
- 标记完成时弹出底部弹窗
- 加载时显示loading动画
- 操作成功显示Toast提示

---

## 📊 数据流

### 查询训练计划详情流程

```
小程序端
  ↓
调用 getTrainingPlanById(planId)
  ↓
后端查询 gym_training_plan 表
  ↓
关联查询 gym_training_plan_detail 表
  ↓
关联查询 gym_training_action 表（获取动作名称）
  ↓
组装 TrainingPlanResponseDTO
  ↓
返回小程序端
  ↓
按星期分组显示
```

### 标记完成流程

```
用户点击"标记完成"
  ↓
弹出表单填写实际数据
  ↓
调用 updateDetailCompletion(detailId, params)
  ↓
后端更新 gym_training_plan_detail 表
  - isCompleted = 1
  - completeTime = 当前时间
  - actualSets = 实际组数
  - actualReps = 实际次数
  - executionNote = 训练感受
  ↓
返回成功
  ↓
刷新页面显示最新状态
```

### 进度计算流程

```
调用 calculateProgress(planId)
  ↓
查询该计划的所有训练明细
  ↓
统计:
  - totalCount: 总项目数
  - completedCount: 已完成项目数
  ↓
计算: progress = (completedCount / totalCount) × 100
  ↓
返回进度百分比
```

---

## 🧪 测试要点

### 功能测试

#### 1. 训练计划列表
- [ ] 正确显示用户的所有训练计划
- [ ] 状态筛选功能正常
- [ ] 进度百分比计算正确
- [ ] 点击跳转到详情页
- [ ] 空数据时显示提示

#### 2. 训练计划详情
- [ ] 计划基本信息显示完整
- [ ] 按星期正确分组显示
- [ ] 进度条显示正确
- [ ] 标记完成功能正常
- [ ] 取消完成功能正常
- [ ] 实际数据正确保存
- [ ] 训练感受正确保存
- [ ] 已完成项目高亮显示

#### 3. 训练历史
- [ ] 正确显示历史记录
- [ ] 按时间倒序排列
- [ ] 数据显示完整
- [ ] 空数据时显示提示

### 边界测试

- [ ] 无网络时的错误提示
- [ ] 未登录时的跳转
- [ ] 计划已结束时不能标记完成
- [ ] 训练感受字数限制（200字）
- [ ] 分页加载功能
- [ ] 并发标记完成

### 性能测试

- [ ] 列表加载速度
- [ ] 详情页渲染性能
- [ ] 进度计算响应时间
- [ ] 大量数据时的滚动性能

---

## 🚀 部署说明

### 1. 数据库迁移

```bash
# 进入项目目录
cd D:\健身房预约小程序

# 执行迁移脚本
mysql -u root -p gym_booking_system < springboot/database/training_plan_detail_extension.sql
```

### 2. 后端部署

```bash
# 重新编译项目
cd springboot
mvn clean package

# 重启服务
# Windows: 
java -jar target/springboot-0.0.1-SNAPSHOT.jar

# Linux:
nohup java -jar target/springboot-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
```

### 3. 小程序端部署

```bash
# 进入uniapp目录
cd uniapp

# 安装依赖（如果是首次部署）
npm install

# 编译小程序
npm run dev:mp-weixin

# 使用微信开发者工具打开 dist/dev/mp-weixin 目录
# 预览和上传代码
```

---

## 📖 使用说明

### 用户操作指南

#### 查看训练计划
1. 进入"我的"页面
2. 点击"训练计划"菜单
3. 查看所有训练计划列表
4. 可以按状态筛选（全部/进行中/已结束）

#### 执行训练
1. 点击某个训练计划进入详情
2. 查看本周的训练安排
3. 完成训练后点击"标记完成"
4. 填写实际完成情况（组数、次数）
5. 添加训练感受（可选）
6. 提交后可以看到进度更新

#### 查看历史
1. 在详情页点击"训练历史"
2. 查看所有已完成的训练记录
3. 可以查看每次训练的详细数据和感受

---

## 🔄 后续优化建议

### 功能增强
1. **训练提醒**: 添加训练计划的定时提醒功能
2. **数据统计**: 添加训练数据的图表统计
3. **社交分享**: 支持分享训练成果
4. **训练日历**: 添加日历视图查看训练安排
5. **离线支持**: 支持离线查看训练计划

### 性能优化
1. **数据缓存**: 缓存训练计划数据减少请求
2. **懒加载**: 列表滚动加载优化
3. **图片优化**: 如果添加动作图片，需要图片压缩
4. **请求合并**: 批量查询进度数据

### UI优化
1. **动画效果**: 添加更流畅的过渡动画
2. **骨架屏**: 加载时显示骨架屏
3. **下拉刷新**: 支持下拉刷新列表
4. **空状态优化**: 更友好的空状态提示

---

## 🐛 常见问题

### Q1: 进度不更新？
**A**: 检查是否正确调用了 `calculateProgress` 接口，确保在标记完成后刷新了页面。

### Q2: 无法标记完成？
**A**: 确认：
- 训练计划状态为"进行中"
- 用户已登录
- 网络连接正常

### Q3: 训练历史显示为空？
**A**: 确认：
- 用户ID正确
- 已有完成的训练记录
- 数据库中 `is_completed = 1` 的记录存在

### Q4: 数据库迁移失败？
**A**: 
- 检查数据库连接
- 确认数据库名称正确
- 查看是否有权限问题

---

## 📝 变更记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-12-11 | 初版发布，完成训练计划小程序端基础功能 |

---

## 👥 开发团队

- **后端开发**: 扩展 Service、Controller、Entity
- **前端开发**: UniApp页面和API封装
- **数据库**: 表结构扩展和迁移脚本

---

## 📞 技术支持

如遇问题，请参考：
1. 本文档的常见问题部分
2. 项目README文档
3. 接口Swagger文档：http://localhost:9090/doc.html

---

**文档结束**
