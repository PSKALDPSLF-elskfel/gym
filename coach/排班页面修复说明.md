# 教练端排班页面修复说明

## 问题描述
教练端的"我的排班"页面没有显示该教练要上班的信息。

## 问题原因

### 1. 数据库表结构
系统中有两个重要的ID概念：
- **userId**: `user`表的主键ID，代表用户账号
- **coachId**: `gym_coach`表的主键ID，代表教练记录

两个表的关系：
```
user (用户表)
└── id (用户ID)
    └── gym_coach (教练表)
        ├── id (教练ID)
        └── user_id (关联到user.id)
```

### 2. 前端代码错误
在教练端的多个页面中，错误地使用了 `userStore.user?.id`（用户ID）来查询排班，而后端API需要的是 `coachId`（教练ID）。

**错误示例：**
```javascript
const response = await getMonthlySchedule({
  coachId: userStore.user?.id || 1,  // ❌ 错误：这是用户ID，不是教练ID
  year: currentYear.value,
  month: currentMonth.value
})
```

### 3. 数据示例
根据gym.sql中的数据：
- 教练李梦琪：userId = 4, coachId = 1
- 教练王强：userId = 5, coachId = 2
- 教练张晓敏：userId = 6, coachId = 3

如果教练李梦琪登录（userId=4），系统错误地用userId=4去查询排班，但排班表中记录的是coachId=1，所以查询不到数据。

## 解决方案

### 1. 修改登录逻辑（已实现）
在登录时获取并保存教练ID：

**文件：`src/views/auth/Login.vue`**
```javascript
// 获取教练信息
const coachResponse = await request.get('/coaches/info')

// 保存用户信息（包含coachId）
userStore.setUser({
  id: userInfo.id,           // 用户ID
  username: userInfo.username,
  coachId: coachResponse.id  // ✅ 教练ID
})
```

### 2. 修改查询接口调用（已修复）

#### 文件1: `src/views/schedule/Calendar.vue`
修改了3处：
```javascript
// ✅ 加载月度排班
const response = await getMonthlySchedule({
  coachId: userStore.user?.coachId || 1,  // 使用coachId
  year: currentYear.value,
  month: currentMonth.value
})

// ✅ 创建排班
const requestData = {
  coachId: userStore.user?.coachId || 1,  // 使用coachId
  workDate: scheduleForm.workDate.format('YYYY-MM-DD'),
  // ...
}
```

#### 文件2: `src/views/schedule/Attendance.vue`
修改了2处：
```javascript
// ✅ 加载今日排班
const response = await getTodaySchedule({
  coachId: userStore.user?.coachId || 1
})

// ✅ 加载打卡记录
const response = await getAttendanceRecords({
  coachId: userStore.user?.coachId || 1,
  page: pagination.current,
  size: pagination.pageSize
})
```

#### 文件3: `src/views/schedule/Request.vue`
修改了1处：
```javascript
// ✅ 加载申请记录
const response = await getScheduleRequests({
  coachId: userStore.user?.coachId || 1,
  page: pagination.current,
  size: pagination.pageSize
})
```

#### 文件4: `src/views/schedule/Statistics.vue`
修改了1处：
```javascript
// ✅ 加载统计数据
const response = await getMonthlyStatistics({
  coachId: userStore.user?.coachId || 1,
  year: selectedYear.value,
  month: selectedMonth.value
})
```

## 测试验证

### 1. 登录测试
使用教练账号登录后，检查浏览器控制台或localStorage，确认保存的用户信息包含coachId：
```javascript
{
  "id": 4,              // 用户ID
  "username": "coach1",
  "coachId": 1          // 教练ID ✅
}
```

### 2. 排班数据测试
访问"我的排班"页面，应该能看到该教练的排班信息：
- 教练ID为1的，应该能看到12月13日和12月13日的排班
- 教练ID为2的，应该能看到12月14日的排班
- 教练ID为3的，应该能看到12月13日的排班

### 3. API调用测试
打开浏览器开发者工具的网络面板，检查API调用：
```
GET /coach-schedule/schedule/monthly?coachId=1&year=2025&month=12
```
确认参数coachId是教练ID（1、2、3），而不是用户ID（4、5、6）。

## 注意事项

1. **后端API设计**：所有教练相关的API都应该使用coachId作为参数
2. **前端状态管理**：登录后必须同时保存userId和coachId
3. **默认值处理**：代码中的 `|| 1` 是开发时的默认值，生产环境应该移除或改为错误提示

## 相关文件清单

### 修改的文件
- ✅ `src/views/schedule/Calendar.vue`
- ✅ `src/views/schedule/Attendance.vue`  
- ✅ `src/views/schedule/Request.vue`
- ✅ `src/views/schedule/Statistics.vue`

### 已正确的文件
- ✅ `src/views/auth/Login.vue` (已包含获取coachId逻辑)
- ✅ `src/store/user.js` (已支持保存完整用户信息)

## 修复日期
2025-12-19
