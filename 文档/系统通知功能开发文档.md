# 系统通知功能开发文档

## 功能概述

系统通知功能为健身房预约小程序提供了完善的消息推送能力,支持:
- ✅ 系统通知、预约提醒、课程通知、器材通知、会员通知等多种类型
- ✅ 单用户推送和群发推送
- ✅ 定时发送和立即发送
- ✅ 通知优先级设置
- ✅ 已读/未读状态管理
- ✅ 通知关联业务对象

## 数据库设计

### 1. sys_notification (系统通知表)
```sql
CREATE TABLE `sys_notification` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '通知ID',
  `notification_type` varchar(50) NOT NULL COMMENT '通知类型',
  `title` varchar(200) NOT NULL COMMENT '通知标题',
  `content` text NOT NULL COMMENT '通知内容',
  `target_user_type` varchar(50) DEFAULT NULL COMMENT '目标用户类型',
  `target_user_id` bigint DEFAULT NULL COMMENT '目标用户ID',
  `related_id` varchar(255) DEFAULT NULL COMMENT '关联业务ID',
  `related_type` varchar(50) DEFAULT NULL COMMENT '关联业务类型',
  `icon` varchar(255) DEFAULT NULL COMMENT '通知图标URL',
  `priority` tinyint DEFAULT 0 COMMENT '优先级',
  `status` tinyint DEFAULT 1 COMMENT '状态',
  `send_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
  `scheduled_time` datetime DEFAULT NULL COMMENT '定时发送时间',
  `is_read_required` tinyint DEFAULT 1 COMMENT '是否需要标记已读',
  `remark` text COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB COMMENT='系统通知表';
```

### 2. sys_notification_read (用户通知读取记录表)
```sql
CREATE TABLE `sys_notification_read` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `notification_id` bigint NOT NULL COMMENT '通知ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `read_time` datetime DEFAULT NULL COMMENT '读取时间',
  `is_read` tinyint DEFAULT 0 COMMENT '是否已读',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_notification_user` (`notification_id`,`user_id`)
) ENGINE=InnoDB COMMENT='用户通知读取记录表';
```

## 后端实现

### 1. 实体类
- `SysNotification.java` - 系统通知实体
- `SysNotificationRead.java` - 通知读取记录实体

### 2. 枚举类
- `NotificationType.java` - 通知类型枚举
  - SYSTEM: 系统通知
  - BOOKING: 预约提醒
  - COURSE: 课程相关
  - EQUIPMENT: 器材相关
  - MEMBERSHIP: 会员相关

- `NotificationPriority.java` - 通知优先级枚举
  - LOW: 低优先级(0)
  - MEDIUM: 中优先级(1)
  - HIGH: 高优先级(2)

- `TargetUserType.java` - 目标用户类型枚举
  - USER: 小程序用户
  - ADMIN: 管理员
  - COACH: 教练
  - ALL: 全部

### 3. DTO
- `NotificationCreateDTO.java` - 创建通知DTO
- `NotificationResponseDTO.java` - 通知响应DTO

### 4. Service层
`NotificationService.java` 提供以下核心方法:

```java
// 发送通知(单个用户或群发)
Long sendNotification(NotificationCreateDTO dto)

// 批量发送通知给指定用户列表
void sendBatchNotification(NotificationCreateDTO dto, List<Long> userIds)

// 获取用户通知列表(分页)
Page<NotificationResponseDTO> getUserNotifications(Long userId, ...)

// 获取用户未读通知数量
Long getUnreadCount(Long userId)

// 标记通知为已读
void markAsRead(Long notificationId, Long userId)

// 批量标记为已读
void markAllAsRead(Long userId)

// 删除通知(软删除)
void deleteNotification(Long notificationId, Long userId)

// 管理端-分页查询所有通知
Page<NotificationResponseDTO> selectPage(...)

// 管理端-删除通知(物理删除)
void deleteNotificationById(Long notificationId)
```

### 5. Controller层
`NotificationController.java` 提供以下API接口:

#### 用户端接口
- `GET /api/notifications/my` - 获取我的通知列表
- `GET /api/notifications/unread/count` - 获取未读数量
- `PUT /api/notifications/{notificationId}/read` - 标记已读
- `PUT /api/notifications/read/all` - 全部标记已读
- `DELETE /api/notifications/{notificationId}` - 删除通知

#### 管理端接口
- `POST /api/notifications/send` - 发送通知
- `POST /api/notifications/send/batch` - 批量发送通知
- `GET /api/notifications/admin/list` - 查询所有通知
- `DELETE /api/notifications/admin/{notificationId}` - 删除通知

## API使用示例

### 1. 发送系统通知(管理端)
```http
POST /api/notifications/send
Content-Type: application/json

{
  "notificationType": "SYSTEM",
  "title": "系统维护通知",
  "content": "本系统将于今晚22:00-23:00进行系统升级维护，届时将无法访问。",
  "targetUserType": "ALL",
  "priority": 2,
  "icon": "/images/system.png",
  "isReadRequired": 1
}
```

### 2. 发送预约提醒(单个用户)
```http
POST /api/notifications/send
Content-Type: application/json

{
  "notificationType": "BOOKING",
  "title": "课程预约提醒",
  "content": "您预约的瑜伽课程将于明天上午10:00开始，请提前到达。",
  "targetUserType": "USER",
  "targetUserId": 123,
  "relatedId": "456",
  "relatedType": "COURSE_BOOKING",
  "priority": 1,
  "isReadRequired": 1
}
```

### 3. 定时发送会员到期提醒
```http
POST /api/notifications/send
Content-Type: application/json

{
  "notificationType": "MEMBERSHIP",
  "title": "会员即将到期",
  "content": "您的黄金会员将于3天后到期，请及时续费。",
  "targetUserId": 123,
  "scheduledTime": "2025-12-14T10:00:00",
  "priority": 1
}
```

### 4. 批量发送器材维护通知
```http
POST /api/notifications/send/batch?userIds=1,2,3,4,5
Content-Type: application/json

{
  "notificationType": "EQUIPMENT",
  "title": "器材维护通知",
  "content": "跑步机A3将于今日下午进行维护，暂时无法使用。",
  "targetUserType": "USER",
  "priority": 0
}
```

### 5. 获取我的通知列表
```http
GET /api/notifications/my?current=1&size=10&isRead=0
Authorization: Bearer {token}
```

### 6. 获取未读通知数量
```http
GET /api/notifications/unread/count
Authorization: Bearer {token}
```

### 7. 标记通知为已读
```http
PUT /api/notifications/123/read
Authorization: Bearer {token}
```

### 8. 全部标记为已读
```http
PUT /api/notifications/read/all
Authorization: Bearer {token}
```

## 业务场景集成

### 1. 预约成功通知
在课程预约成功后自动发送通知:

```java
@Service
public class CourseBookingService {
    @Resource
    private NotificationService notificationService;
    
    @Transactional
    public void createBooking(CourseBookingCreateDTO dto, Long userId) {
        // 创建预约记录
        // ...
        
        // 发送通知
        NotificationCreateDTO notification = NotificationCreateDTO.builder()
            .notificationType("BOOKING")
            .title("课程预约成功")
            .content("您已成功预约" + courseName + "，时间：" + startTime)
            .targetUserId(userId)
            .relatedId(bookingId.toString())
            .relatedType("COURSE_BOOKING")
            .priority(1)
            .build();
        notificationService.sendNotification(notification);
    }
}
```

### 2. 会员到期提醒(定时任务)
使用定时任务每天检查并发送会员到期提醒:

```java
@Component
public class MembershipExpiryScheduler {
    @Resource
    private NotificationService notificationService;
    @Resource
    private UserMembershipService membershipService;
    
    @Scheduled(cron = "0 0 9 * * ?") // 每天早上9点执行
    public void checkMembershipExpiry() {
        // 查询3天内到期的会员
        List<UserMembership> expiringMembers = membershipService.getExpiringIn3Days();
        
        for (UserMembership membership : expiringMembers) {
            NotificationCreateDTO notification = NotificationCreateDTO.builder()
                .notificationType("MEMBERSHIP")
                .title("会员即将到期")
                .content("您的会员将于" + membership.getEndTime() + "到期，请及时续费")
                .targetUserId(membership.getUserId())
                .priority(1)
                .build();
            notificationService.sendNotification(notification);
        }
    }
}
```

### 3. 课程变更通知
课程时间或状态变更时通知所有预约学员:

```java
@Service
public class CourseScheduleService {
    @Resource
    private NotificationService notificationService;
    @Resource
    private CourseBookingService bookingService;
    
    @Transactional
    public void updateSchedule(Long scheduleId, CourseScheduleUpdateDTO dto) {
        // 更新排课信息
        // ...
        
        // 获取所有预约该课程的用户
        List<Long> userIds = bookingService.getBookingUserIds(scheduleId);
        
        // 批量发送通知
        NotificationCreateDTO notification = NotificationCreateDTO.builder()
            .notificationType("COURSE")
            .title("课程时间变更")
            .content("您预约的课程时间已变更，请查看详情")
            .relatedId(scheduleId.toString())
            .relatedType("COURSE_SCHEDULE")
            .priority(2)
            .build();
        notificationService.sendBatchNotification(notification, userIds);
    }
}
```

### 4. 器材使用提醒
器材预约即将开始时发送提醒:

```java
@Component
public class EquipmentReminderScheduler {
    @Resource
    private NotificationService notificationService;
    
    @Scheduled(fixedRate = 300000) // 每5分钟检查一次
    public void checkUpcomingBookings() {
        // 查询15分钟后开始的预约
        List<EquipmentBooking> upcomingBookings = equipmentBookingService.getUpcomingBookings(15);
        
        for (EquipmentBooking booking : upcomingBookings) {
            NotificationCreateDTO notification = NotificationCreateDTO.builder()
                .notificationType("EQUIPMENT")
                .title("器材预约提醒")
                .content("您预约的" + booking.getEquipmentName() + "将于15分钟后开始")
                .targetUserId(booking.getUserId())
                .relatedId(booking.getId().toString())
                .relatedType("EQUIPMENT_BOOKING")
                .priority(1)
                .build();
            notificationService.sendNotification(notification);
        }
    }
}
```

## 前端集成建议

### 小程序端
1. 在首页显示未读通知数量角标
2. 创建通知列表页面，支持筛选和分页
3. 点击通知跳转到相关业务页面
4. 长按删除通知

### 管理后台
1. 创建通知发送页面，支持选择目标用户和定时发送
2. 创建通知历史查询页面
3. 支持模板化发送（预设常用通知模板）

## 注意事项

1. **性能优化**: 群发通知时，如果用户数量过多，建议使用异步任务或消息队列处理
2. **通知去重**: 同一业务事件避免重复发送通知
3. **已读状态**: 用户删除通知会同时删除读取记录
4. **定时发送**: 需要配置定时任务定期检查并发送 `scheduled_time` 到达的通知
5. **通知清理**: 建议定期清理已删除或过期的通知记录

## 扩展功能建议

1. **推送通道**: 集成微信模板消息或服务号推送
2. **通知分组**: 支持通知分类和折叠展示
3. **富文本内容**: 支持图片、链接等富文本内容
4. **通知设置**: 允许用户自定义接收哪些类型的通知
5. **通知统计**: 统计通知的送达率、打开率等指标

## 开发完成清单

- ✅ 实体类创建 (SysNotification, SysNotificationRead)
- ✅ 枚举类创建 (NotificationType, NotificationPriority, TargetUserType)
- ✅ Mapper接口创建 (SysNotificationMapper, SysNotificationReadMapper)
- ✅ DTO创建 (NotificationCreateDTO, NotificationResponseDTO)
- ✅ Service层实现 (NotificationService)
- ✅ Controller层实现 (NotificationController)
- ✅ Swagger API文档支持

## 下一步工作

1. ⏳ 前端页面开发(Vue3管理端 + UniApp小程序端)
2. ⏳ 集成到各业务模块(预约、课程、会员等)
3. ⏳ 定时任务配置(会员到期提醒、器材预约提醒等)
4. ⏳ 接口测试和功能验证
5. ⏳ 微信模板消息集成(可选)

---

**开发完成时间**: 2025-12-11  
**开发者**: System  
**版本**: v1.0
