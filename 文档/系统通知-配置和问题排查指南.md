# 系统通知功能 - 配置和问题排查指南

## 🔧 API配置问题诊断

### 错误现象
```
业务错误 [5]: {code: "500", msg: "No static resource api/notifications/unread/count."}
获取未读数量失败: {type: "business", code: "500", message: "No static resource api/notifications/unread/count."}
```

### 问题原因
这个错误通常表示:
1. ❌ 后端服务没有启动
2. ❌ API地址配置不正确 (端口号错误)
3. ❌ 网络连接问题
4. ❌ CORS跨域问题

---

## ✅ 解决方案

### 方案一: 检查后端服务

#### 步骤1: 启动后端服务

**Spring Boot项目启动:**
```bash
# 进入springboot目录
cd D:\健身房预约小程序\springboot

# 使用Maven启动
mvn spring-boot:run

# 或使用IDE直接运行 SpringbootApplication.java
```

**验证启动成功:**
```bash
# 访问健康检查端点 (如果配置了)
curl http://localhost:8080/actuator/health

# 或访问某个现有接口
curl http://localhost:8080/api/user/current
```

#### 步骤2: 检查端口号

**SpringBoot默认配置:**
- 文件: `springboot/src/main/resources/application.yml`
- 查看端口配置:

```yaml
server:
  port: 8080  # 确保是8080,不要是其他端口
```

#### 步骤3: 验证API访问

**使用浏览器或Postman测试:**
```
GET http://localhost:8080/api/notifications/unread/count
Header: Authorization: Bearer {your_token}
```

**预期响应:**
```json
{
  "code": "200",
  "message": "操作成功",
  "data": 5
}
```

---

### 方案二: 检查小程序端配置

#### 步骤1: 修改API地址

**文件:** `uniapp/utils/request.js`

```javascript
const baseConfig = {
  // #ifndef H5
  baseURL: 'http://localhost:8080/api',  // 确保端口号为8080
  // #endif
  // ... 其他配置
}
```

#### 步骤2: 开启调试日志

查看控制台输出，应该看到:
```
🌐 API Base URL: http://localhost:8080/api
📍 Full URL: http://localhost:8080/api/notifications/unread/count
```

#### 步骤3: 检查token

确保当前用户已登录且有有效的token:
```javascript
// 在我的页面或任何页面的开发者工具中检查
const userStore = useUserStore()
console.log('User Token:', userStore.token)
console.log('Is Logged In:', userStore.isLoggedIn)
```

---

## 🧪 完整测试流程

### 1. 后端服务检查

```bash
# 1.1 启动后端
cd springboot
mvn spring-boot:run

# 1.2 验证服务运行
# 打开浏览器访问
http://localhost:8080/api/user/current

# 应该看到401错误(因为没有token),这说明后端正常运行
```

### 2. 前端小程序配置

```bash
# 2.1 打开微信开发者工具
# 2.2 导入uniapp项目

# 2.3 在开发者工具中编译运行
# - 选择"小程序模拟器"或"真机预览"

# 2.4 打开控制台看日志
# 开发者工具 -> 控制台 tab
```

### 3. 测试通知功能

```
步骤1: 登录账号
  - 点击我的 -> 登录
  - 输入用户名和密码

步骤2: 进入通知页面
  - 点击我的 -> 系统通知
  - 查看是否正确加载通知列表

步骤3: 验证功能
  - 检查是否显示未读数量角标
  - 点击通知是否能查看详情
  - 点击"全部已读"是否能更新状态
```

---

## 📋 常见问题排查表

| 问题 | 症状 | 解决方案 |
|------|------|--------|
| 后端未启动 | 所有API都500错误 | 启动SpringBoot服务 |
| 端口号错误 | 连接超时 | 改为http://localhost:8080 |
| 没有登录token | 401错误 | 先登录获取token |
| CORS问题 | 跨域错误 | 后端配置CORS(见下方) |
| 网络不通 | 请求超时 | 检查本地网络配置 |
| 通知表没有数据 | 空列表 | 后端先手动插入测试数据 |

---

## 🔐 后端CORS配置 (如果需要)

如果遇到跨域问题,在后端配置CORS:

**文件:** `springboot/src/main/java/org/example/springboot/config/WebConfig.java`

```java
package org.example.springboot.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
            .allowedOrigins("*")
            .allowedMethods("*")
            .allowedHeaders("*")
            .allowCredentials(true)
            .maxAge(3600);
    }
}
```

---

## 🐛 调试技巧

### 1. 查看完整请求URL

在 `request.js` 中已添加:
```javascript
console.log('🌐 API Base URL:', baseConfig.baseURL)
console.log('📍 Full URL:', fullUrl)
```

### 2. 查看请求/响应详情

小程序开发者工具 -> 网络tab:
- 查看请求URL是否正确
- 查看响应状态码和内容
- 查看请求头中是否包含Authorization

### 3. 检查token有效性

```javascript
// 在任何组件中检查
import { useUserStore } from '@/store/user.js'

const userStore = useUserStore()
console.log('Current Token:', userStore.token)
console.log('Token有效期:', userStore.tokenExpireTime)
```

### 4. 手动测试API

使用Postman或curl:
```bash
# 获取未读数量
curl -X GET "http://localhost:8080/api/notifications/unread/count" \
  -H "Authorization: Bearer {your_token}" \
  -H "Content-Type: application/json"

# 获取通知列表
curl -X GET "http://localhost:8080/api/notifications/my?current=1&size=10" \
  -H "Authorization: Bearer {your_token}" \
  -H "Content-Type: application/json"
```

---

## 📝 端口号说明

### 常见端口配置:

| 服务 | 默认端口 | 配置文件 |
|------|---------|---------|
| Spring Boot | 8080 | application.yml |
| MySQL | 3306 | MySQL配置 |
| Redis | 6379 | Redis配置 |
| 小程序代理 | 5000 | vite.config.js |

### 修改Spring Boot端口:

**application.yml:**
```yaml
server:
  port: 8080
```

**application.properties:**
```properties
server.port=8080
```

---

## ✨ 验证修复成功

### 标志1: 控制台日志正确
```
🌐 API Base URL: http://localhost:8080/api
📍 Full URL: http://localhost:8080/api/notifications/unread/count
📤 发送请求 [1]: { method: 'GET', url: '/notifications/unread/count' }
📥 收到响应 [1]: { method: 'GET', code: '200', time: '125ms', statusCode: 200 }
```

### 标志2: 通知页面正常加载
```
✅ 通知列表显示正确
✅ 未读角标显示正确
✅ 可以筛选通知
✅ 可以标记已读
```

### 标志3: 网络请求成功
```
开发者工具 -> 网络 tab
✅ 所有请求状态码为200
✅ 没有404或500错误
✅ 响应数据正确显示
```

---

## 🚀 快速修复步骤 (5分钟)

如果遇到"No static resource"错误,按以下步骤快速修复:

### 步骤1: 确认后端运行 (2分钟)
```bash
# 启动SpringBoot
cd springboot && mvn spring-boot:run
```

### 步骤2: 检查端口号 (1分钟)
```
验证: http://localhost:8080 能访问
检查: springboot/src/main/resources/application.yml 中 server.port 是8080
```

### 步骤3: 更新小程序配置 (1分钟)
```
编辑: uniapp/utils/request.js
改为: baseURL: 'http://localhost:8080/api'
```

### 步骤4: 重新运行 (1分钟)
```
小程序开发者工具 -> 重新编译
检查: 控制台日志是否显示正确的URL
```

---

## 📞 仍需帮助?

如果按照以上步骤仍未解决,请检查:

1. **后端日志**
   - 查看SpringBoot启动日志
   - 确认通知表是否存在

2. **小程序日志**
   - 开发者工具 -> 控制台
   - 查看完整的错误堆栈

3. **数据库**
   - 确认sys_notification表已创建
   - 确认sys_notification_read表已创建

4. **数据库初始化**
   ```bash
   # 运行SQL初始化脚本
   mysql -u root -p gym < springboot/notification_test_data.sql
   ```

---

**最后更新:** 2025-12-11  
**版本:** v1.0
