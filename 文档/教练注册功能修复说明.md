# 教练注册功能修复说明

## 问题描述

在注册教练账号后登录系统，访问学员管理页面时出现错误：

```
Error: 当前用户不是教练
```

## 问题原因

注册流程只在 `user` 表中创建了用户记录，但当用户类型为 `COACH` 时，没有同时在 `gym_coach` 表中创建对应的教练信息记录。

系统在查询教练的学员列表时，会通过 `CoachStudentService.getCoachIdByUserId()` 方法从 `gym_coach` 表中查找教练ID。如果找不到记录，就会抛出"当前用户不是教练"的异常。

### 相关代码位置

**CoachStudentService.java (第39-47行)**
```java
public Long getCoachIdByUserId(Long userId) {
    LambdaQueryWrapper<GymCoach> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(GymCoach::getUserId, userId);
    GymCoach coach = coachMapper.selectOne(wrapper);
    if (coach == null) {
        throw new BusinessException("当前用户不是教练");  // ⚠️ 这里抛出异常
    }
    return coach.getId();
}
```

## 解决方案

修改 `UserService.register()` 方法，在用户注册时，如果用户类型为 `COACH`，同时在 `gym_coach` 表中创建教练信息记录。

### 修改内容

**文件**：`springboot/src/main/java/org/example/springboot/service/UserService.java`

#### 1. 添加依赖注入

```java
@Resource
private GymCoachMapper coachMapper;
```

#### 2. 添加必要的导入

```java
import java.math.BigDecimal;
import org.example.springboot.entity.GymCoach;
import org.example.springboot.mapper.GymCoachMapper;
```

#### 3. 修改注册方法

在 `register()` 方法中，插入用户记录后添加以下代码：

```java
// 如果是教练类型，同时创建教练信息
if ("COACH".equals(registerDTO.getUserType())) {
    GymCoach coach = GymCoach.builder()
            .userId(user.getId())
            .specialty("") // 默认为空，后续可由教练完善
            .introduction("") // 默认为空
            .rating(new BigDecimal("0.0")) // 默认评分为0
            .status(1) // 默认在职
            .createTime(LocalDateTime.now())
            .updateTime(LocalDateTime.now())
            .build();
    coachMapper.insert(coach);
    log.info("教练信息创建成功: userId={}, coachId={}", user.getId(), coach.getId());
}
```

## 数据表关系

```
┌─────────────────┐         ┌──────────────────┐
│  user           │         │  gym_coach       │
├─────────────────┤         ├──────────────────┤
│ id (PK)         │<───┐    │ id (PK)          │
│ username        │    └────│ user_id (FK)     │
│ user_type       │         │ specialty        │
│ ...             │         │ introduction     │
└─────────────────┘         │ rating           │
                            │ status           │
                            └──────────────────┘
```

- `user.user_type = 'COACH'` 时，必须在 `gym_coach` 表中有对应记录
- `gym_coach.user_id` 外键关联到 `user.id`

## 测试验证

### 1. 注册新教练账号

访问注册页面：`http://localhost:5173/register`

填写信息：
- 用户名：testcoach
- 邮箱：coach@example.com
- 手机号：13800138000
- 密码：123456
- 账户类型：教练

### 2. 验证数据库记录

注册成功后，检查数据库：

```sql
-- 查询用户表
SELECT * FROM user WHERE username = 'testcoach';

-- 查询教练表（应该能找到对应记录）
SELECT c.*, u.username 
FROM gym_coach c 
JOIN user u ON c.user_id = u.id 
WHERE u.username = 'testcoach';
```

### 3. 登录并访问学员管理

1. 使用注册的账号登录
2. 访问"学员管理"页面
3. 应该能正常显示（即使列表为空），不再报"当前用户不是教练"错误

## 已有账号的处理

如果之前注册的教练账号没有对应的 `gym_coach` 记录，可以通过以下SQL手动创建：

```sql
-- 为已存在的教练用户创建教练记录
INSERT INTO gym_coach (user_id, specialty, introduction, rating, status, create_time, update_time)
SELECT 
    id,
    '' as specialty,
    '' as introduction,
    0.0 as rating,
    1 as status,
    NOW() as create_time,
    NOW() as update_time
FROM user 
WHERE user_type = 'COACH' 
AND id NOT IN (SELECT user_id FROM gym_coach);
```

## 影响范围

- ✅ 新注册的教练账号可以正常使用所有教练端功能
- ✅ 不影响已有的正常数据
- ✅ 不影响管理员和普通用户的注册
- ✅ 保持数据一致性

## 相关文件

- `springboot/src/main/java/org/example/springboot/service/UserService.java` - 修改注册逻辑
- `springboot/src/main/java/org/example/springboot/service/CoachStudentService.java` - 教练学员服务（报错位置）
- `springboot/src/main/java/org/example/springboot/entity/GymCoach.java` - 教练实体类
- `springboot/src/main/java/org/example/springboot/mapper/GymCoachMapper.java` - 教练数据访问层

## 注意事项

1. 此修复采用事务管理（`@Transactional`），确保用户和教练记录同时创建成功或同时回滚
2. 教练信息的初始值（specialty、introduction）为空字符串，教练可以后续在个人信息页面完善
3. 默认评分为 0.0，状态为在职（1）
4. 只有用户类型为 `COACH` 时才会创建教练记录，不影响其他类型用户

## 修复日期

2025-12-11
