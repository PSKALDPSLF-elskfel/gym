# 教练评价功能 - 快速使用指南

## 📚 目录
1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [核心功能](#核心功能)
4. [文件清单](#文件清单)
5. [常见问题](#常见问题)

---

## 功能概述

### ✨ 功能特性

#### 用户端功能
- ✅ **创建评价**: 对教练的课程或训练计划进行评价
- ✅ **星级评分**: 1-5星评分系统
- ✅ **标签选择**: 快速选择评价标签（专业、耐心等）
- ✅ **图片上传**: 最多上传9张评价图片
- ✅ **匿名评价**: 支持匿名发表评价
- ✅ **评价管理**: 查看、删除自己的评价
- ✅ **点赞功能**: 为有帮助的评价点赞
- ✅ **评价筛选**: 按教练、评分筛选评价

#### 教练端功能
- ✅ **评价查看**: 查看收到的所有评价
- ✅ **评价回复**: 回复学员的评价
- ✅ **数据统计**: 查看评价统计数据
  - 总评价数
  - 平均评分
  - 各星级数量分布
  - 回复率统计

#### 系统功能
- ✅ **评价统计**: 自动计算和更新统计数据
- ✅ **标签管理**: 预设评价标签库
- ✅ **防重复评价**: 同一用户对同一对象只能评价一次
- ✅ **数据完整性**: 完善的外键约束和索引

---

## 快速开始

### 步骤1: 导入数据库

```bash
# 进入数据库目录
cd D:\健身房预约小程序\springboot\database

# 导入SQL文件
mysql -u root -p gym < coach_review_system.sql
```

**验证导入**:
```sql
-- 查看表是否创建成功
SHOW TABLES LIKE 'gym_%review%';

-- 应该看到以下4个表：
-- gym_coach_review
-- gym_coach_review_statistics
-- gym_review_tag
-- gym_review_helpful

-- 查看预设标签
SELECT * FROM gym_review_tag ORDER BY sort_order;
```

---

### 步骤2: 启动后端服务

```bash
# 进入项目目录
cd D:\健身房预约小程序\springboot

# 启动服务
mvn spring-boot:run
```

**验证启动**:
- 浏览器访问: http://localhost:8080/doc.html
- 查看是否有 "教练评价管理" 和 "教练端-评价管理" 两个模块

---

### 步骤3: 测试基础功能

#### 3.1 用户创建评价

**请求**:
```bash
POST http://localhost:8080/api/reviews
Authorization: Bearer {user_token}
Content-Type: application/json

{
  "coachId": 1,
  "courseBookingId": 1,
  "reviewType": 2,
  "rating": 5,
  "tagList": ["专业", "耐心", "认真负责"],
  "content": "李教练非常专业，课程讲解很细致，动作示范标准！",
  "images": [],
  "isAnonymous": 0
}
```

**检查**:
```sql
-- 查看新增的评价
SELECT * FROM gym_coach_review ORDER BY id DESC LIMIT 1;

-- 查看统计是否更新
SELECT * FROM gym_coach_review_statistics WHERE coach_id = 1;

-- 查看教练评分是否更新
SELECT rating FROM gym_coach WHERE id = 1;
```

---

#### 3.2 查询评价列表

**请求**:
```bash
GET http://localhost:8080/api/reviews?coachId=1&pageNum=1&pageSize=10
Authorization: Bearer {user_token}
```

**预期结果**:
- 返回教练1的所有评价
- 按置顶和创建时间排序
- 包含用户信息、教练信息、点赞数等

---

#### 3.3 教练回复评价

**请求**:
```bash
POST http://localhost:8080/api/coach/reviews/{reviewId}/reply
Authorization: Bearer {coach_token}
Content-Type: application/json

{
  "reply": "感谢您的认可，我会继续努力！"
}
```

**检查**:
```sql
-- 查看回复是否保存
SELECT reply, reply_time FROM gym_coach_review WHERE id = {reviewId};

-- 查看回复率是否更新
SELECT reply_rate FROM gym_coach_review_statistics WHERE coach_id = 1;
```

---

## 核心功能

### 1. 评价创建流程

```
用户选择教练/课程
    ↓
填写评价信息
    ↓
选择评分（1-5星）
    ↓
选择标签（可选）
    ↓
填写评价内容
    ↓
上传图片（可选）
    ↓
选择是否匿名
    ↓
提交评价
    ↓
系统验证（是否已评价）
    ↓
保存评价记录
    ↓
更新统计数据
    ↓
更新教练评分
```

---

### 2. 评价统计更新逻辑

```java
// 统计更新触发时机
1. 创建评价 → 更新统计
2. 删除评价 → 更新统计
3. 教练回复 → 更新回复率
```

**统计指标**:
- **总评价数**: COUNT(*)
- **平均评分**: AVG(rating)
- **星级分布**: COUNT(*) GROUP BY rating
- **回复率**: (已回复数 / 总评价数) × 100%

---

### 3. 标签系统

**预设标签** (12个正面 + 4个负面):

**正面标签**:
1. 专业
2. 耐心
3. 认真负责
4. 效果显著
5. 幽默风趣
6. 激励性强
7. 活力四射
8. 音乐选得好
9. 动作标准
10. 讲解清晰
11. 体贴细心
12. 知识渊博

**负面标签**:
1. 态度冷淡
2. 讲解不清
3. 经常迟到
4. 不够专业

**标签使用统计**:
```sql
-- 查看热门标签
SELECT tag_name, usage_count 
FROM gym_review_tag 
WHERE tag_type = 1 
ORDER BY usage_count DESC 
LIMIT 10;
```

---

### 4. 点赞机制

**逻辑**:
- 第一次调用: 添加点赞记录
- 第二次调用: 删除点赞记录

**唯一性保证**:
```sql
-- 数据库唯一索引
UNIQUE INDEX `uk_review_user`(`review_id`, `user_id`)
```

**查询点赞状态**:
```sql
-- 检查用户是否点赞过
SELECT * FROM gym_review_helpful 
WHERE review_id = ? AND user_id = ?;
```

---

## 文件清单

### 后端文件

#### 实体类 (Entity)
```
✅ GymCoachReview.java - 评价实体
✅ GymCoachReviewStatistics.java - 统计实体
✅ GymReviewTag.java - 标签实体
✅ GymReviewHelpful.java - 点赞实体
```

#### 枚举类 (Enum)
```
✅ ReviewType.java - 评价类型
✅ ReviewStatus.java - 评价状态
```

#### Mapper接口
```
✅ GymCoachReviewMapper.java
✅ GymCoachReviewStatisticsMapper.java
✅ GymReviewTagMapper.java
✅ GymReviewHelpfulMapper.java
```

#### DTO
**Command (命令)**:
```
✅ CoachReviewCreateDTO.java - 创建评价
✅ CoachReviewReplyDTO.java - 回复评价
```

**Response (响应)**:
```
✅ CoachReviewResponseDTO.java - 评价响应
✅ CoachReviewStatisticsResponseDTO.java - 统计响应
✅ ReviewTagResponseDTO.java - 标签响应
```

#### Service
```
✅ CoachReviewService.java - 核心业务逻辑
```

#### Controller
```
✅ CoachReviewController.java - 用户端API
✅ CoachReviewManageController.java - 教练端API
```

### 数据库文件
```
✅ coach_review_system.sql - 数据库设计和初始化数据
```

### 文档文件
```
✅ API测试文档-教练评价.md - API接口文档
✅ 教练评价功能-快速使用指南.md - 本文档
```

---

## 常见问题

### Q1: 为什么创建评价失败？

**可能原因**:
1. **已经评价过**: 同一用户对同一课程/计划只能评价一次
2. **教练不存在**: coachId无效
3. **评分不合法**: rating必须是1-5之间的整数
4. **内容为空**: content为必填项
5. **图片过多**: 最多只能上传9张图片

**解决方法**:
```sql
-- 检查是否已评价
SELECT * FROM gym_coach_review 
WHERE user_id = ? 
AND coach_id = ? 
AND review_type = ? 
AND (plan_id = ? OR course_booking_id = ?);

-- 如果有记录，则已评价过
```

---

### Q2: 统计数据不准确怎么办？

**手动重新计算统计数据**:
```sql
-- 删除现有统计
DELETE FROM gym_coach_review_statistics WHERE coach_id = 1;

-- 然后通过API触发重新计算
-- 创建一条评价或删除一条评价，系统会自动重新计算
```

**或者编写SQL直接更新**:
```sql
-- 计算教练1的统计数据
UPDATE gym_coach_review_statistics 
SET 
  total_reviews = (
    SELECT COUNT(*) FROM gym_coach_review 
    WHERE coach_id = 1 AND status = 1
  ),
  average_rating = (
    SELECT AVG(rating) FROM gym_coach_review 
    WHERE coach_id = 1 AND status = 1
  ),
  rating_5_count = (
    SELECT COUNT(*) FROM gym_coach_review 
    WHERE coach_id = 1 AND status = 1 AND rating = 5
  )
  -- ... 其他字段类似
WHERE coach_id = 1;
```

---

### Q3: 如何添加新的评价标签？

**方法1: 直接插入数据库**
```sql
INSERT INTO gym_review_tag 
(tag_name, tag_type, sort_order, usage_count, status, create_time, update_time) 
VALUES 
('新标签名称', 1, 100, 0, 1, NOW(), NOW());
```

**方法2: 通过后台管理界面**
（需要额外开发后台管理功能）

---

### Q4: 匿名评价如何显示？

**逻辑**:
- 当 `is_anonymous = 1` 时
- `userNickname` 显示为 "匿名用户"
- `userAvatar` 返回null或默认头像
- 其他信息正常显示

**数据库查看**:
```sql
-- 查看匿名评价
SELECT 
  id,
  user_id,
  is_anonymous,
  content,
  rating
FROM gym_coach_review 
WHERE is_anonymous = 1;
```

---

### Q5: 评价可以修改吗？

**当前版本**: 不支持修改评价，只能删除后重新创建

**如需支持修改**: 需要额外开发以下功能：
1. 添加 `CoachReviewUpdateDTO`
2. 在Service中添加 `updateReview()` 方法
3. 在Controller中添加 `PUT /api/reviews/{id}` 接口
4. 添加修改权限验证（只能修改自己的评价）

---

### Q6: 教练可以删除评价吗？

**当前设计**: 教练不能删除评价，只能回复

**原因**: 保证评价的真实性和公正性

**管理员权限**: 如果需要管理员删除不当评价，需要额外开发后台管理功能

---

### Q7: 点赞数量如何统计？

**实时统计**:
```java
// Service中的逻辑
LambdaQueryWrapper<GymReviewHelpful> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(GymReviewHelpful::getReviewId, reviewId);
Long count = helpfulMapper.selectCount(wrapper);
```

**SQL查询**:
```sql
-- 查询评价的点赞数
SELECT COUNT(*) as helpful_count
FROM gym_review_helpful 
WHERE review_id = 1;
```

---

### Q8: 如何查询某个用户点赞了哪些评价？

**SQL查询**:
```sql
SELECT 
  h.review_id,
  r.content,
  r.rating,
  r.create_time
FROM gym_review_helpful h
JOIN gym_coach_review r ON h.review_id = r.id
WHERE h.user_id = 3
ORDER BY h.create_time DESC;
```

---

## 🎯 最佳实践

### 1. 评价展示顺序
```
推荐排序规则:
1. 置顶评价优先 (is_top = 1)
2. 按创建时间倒序 (create_time DESC)
3. 高分评价优先 (rating DESC)
```

### 2. 标签推荐策略
```
显示规则:
1. 优先展示使用次数多的标签
2. 区分正面和负面标签
3. 最多显示6个标签供快速选择
```

### 3. 统计数据展示
```
推荐展示:
- 平均评分: ⭐⭐⭐⭐⭐ 4.8分
- 总评价: 共100条评价
- 星级分布: 柱状图或饼图
- 回复率: 95%
```

### 4. 性能优化建议
```
1. 评价列表分页加载
2. 统计数据使用缓存（Redis）
3. 大量评价时考虑懒加载
4. 图片使用CDN加速
```

---

## 📊 数据示例

### 示例1: 完整的评价数据
```json
{
  "id": 1,
  "userId": 3,
  "userNickname": "张三",
  "userAvatar": "https://cdn.example.com/avatar/u3.jpg",
  "coachId": 1,
  "coachName": "李教练",
  "courseBookingId": 1,
  "courseName": "瑜伽基础课",
  "reviewType": 2,
  "reviewTypeDesc": "课程评价",
  "rating": 5,
  "tagList": ["专业", "耐心", "认真负责"],
  "content": "李教练非常专业，课程讲解很细致，动作示范标准，每次上课都能学到很多东西！强烈推荐！",
  "images": [
    "https://cdn.example.com/review/img1.jpg",
    "https://cdn.example.com/review/img2.jpg"
  ],
  "isAnonymous": 0,
  "reply": "感谢您的认可，我会继续努力为大家提供更优质的教学服务！期待下次再见！",
  "replyTime": "2025-12-06T10:30:00",
  "isTop": 0,
  "helpfulCount": 15,
  "isHelpfulByCurrentUser": false,
  "status": 1,
  "createTime": "2025-12-05T18:20:00",
  "updateTime": "2025-12-06T10:30:00"
}
```

### 示例2: 统计数据
```json
{
  "coachId": 1,
  "coachName": "李教练",
  "totalReviews": 100,
  "averageRating": 4.85,
  "rating5Count": 85,
  "rating4Count": 12,
  "rating3Count": 2,
  "rating2Count": 1,
  "rating1Count": 0,
  "replyRate": 95.50,
  "lastReviewTime": "2025-12-10T15:30:00"
}
```

---

## 🔗 相关文档

- [API测试文档](./API测试文档-教练评价.md)
- [数据库设计](./database/coach_review_system.sql)
- [开发计划](../缺失功能开发计划.md#模块10学员评价)

---

## ✅ 功能检查清单

开发完成后请逐项检查:

- [ ] 数据库表创建成功
- [ ] 示例数据导入成功
- [ ] 后端服务启动成功
- [ ] Swagger文档可访问
- [ ] 用户可以创建评价
- [ ] 用户可以删除自己的评价
- [ ] 用户可以点赞评价
- [ ] 教练可以查看收到的评价
- [ ] 教练可以回复评价
- [ ] 统计数据计算正确
- [ ] 标签列表显示正常
- [ ] 匿名评价功能正常
- [ ] 防重复评价生效
- [ ] 评分更新到教练表

---

**祝开发顺利！** 🎉
