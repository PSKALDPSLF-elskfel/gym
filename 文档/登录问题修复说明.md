# ğŸ¯ ç™»å½•é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜æ ¹æº

### é—®é¢˜1ï¼šå“åº”æ•°æ®ç±»å‹ä¸åŒ¹é… âš ï¸

**åç«¯è¿”å›çš„æ•°æ®ç»“æ„**ï¼š
```json
{
  "code": "200",        // â† æ³¨æ„ï¼šè¿™æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—ï¼
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "userInfo": {
      "id": 1,
      "username": "admin",
      "nickname": "ç³»ç»Ÿç®¡ç†å‘˜",
      "userType": "ADMIN",
      ...
    },
    "token": "eyJhbGc...",
    "roleType": "ADMIN"
  }
}
```

**å‰ç«¯åŸæ¥çš„åˆ¤æ–­é€»è¾‘**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸² "200" !== æ•°å­— 200 = trueï¼Œæ€»æ˜¯èµ°é”™è¯¯åˆ†æ”¯
if (data.code !== 200) {
  return Promise.reject(new Error(data.message))  // "ç™»å½•æˆåŠŸ" è¢«å½“æˆé”™è¯¯æŠ›å‡º
}
```

### é—®é¢˜2ï¼šå“åº”æ•°æ®ç»“æ„ä¸åŒ¹é…

**åç«¯è¿”å›**ï¼š
```json
{
  "data": {
    "userInfo": { ... },  // ç”¨æˆ·ä¿¡æ¯åœ¨ userInfo å¯¹è±¡ä¸­
    "token": "..."
  }
}
```

**å‰ç«¯æœŸæœ›**ï¼š
```javascript
{
  "id": 1,           // âŒ ç›´æ¥åœ¨ data å±‚çº§
  "username": "...", // âŒ ç›´æ¥åœ¨ data å±‚çº§
  "token": "..."
}
```

---

## âœ… å·²ä¿®å¤çš„å†…å®¹

### 1. **request.js - å“åº”æ‹¦æˆªå™¨**

#### ä¿®å¤å‰ï¼š
```javascript
if (data.code !== 200) {  // âŒ å­—ç¬¦ä¸²æ¯”è¾ƒå¤±è´¥
  message.error(data.message || 'è¯·æ±‚å¤±è´¥')
  return Promise.reject(new Error(data.message))
}
```

#### ä¿®å¤åï¼š
```javascript
// âœ… åŒæ—¶æ”¯æŒå­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹çš„ code
if (data.code !== '200' && data.code !== 200) {
  const errorMsg = data.msg || data.message || 'è¯·æ±‚å¤±è´¥'
  message.error(errorMsg)
  return Promise.reject(new Error(errorMsg))
}
```

### 2. **Login.vue - ç™»å½•é€»è¾‘**

#### ä¿®å¤å‰ï¼š
```javascript
if (response.token) {
  userStore.setUser({
    id: response.id,              // âŒ response ä¸­æ²¡æœ‰ id
    username: response.username,  // âŒ response ä¸­æ²¡æœ‰ username
    userType: response.userType,
    name: response.name           // âŒ åç«¯è¿”å›çš„æ˜¯ nickname
  })
}
```

#### ä¿®å¤åï¼š
```javascript
// âœ… æ­£ç¡®çš„æ•°æ®ç»“æ„ï¼šresponse = { userInfo, token, roleType }
if (response && response.token) {
  const userInfo = response.userInfo  // âœ… ä» userInfo è·å–ç”¨æˆ·æ•°æ®
  
  userStore.setToken(response.token)
  userStore.setUser({
    id: userInfo.id,
    username: userInfo.username,
    userType: userInfo.userType,
    name: userInfo.nickname || userInfo.username,  // âœ… ä½¿ç”¨ nickname
    avatar: userInfo.avatar,
    email: userInfo.email
  })
}
```

### 3. **é”™è¯¯æ¶ˆæ¯å­—æ®µé€‚é…**

```javascript
// âœ… åŒæ—¶æ”¯æŒ msg å’Œ message å­—æ®µ
const errorMsg = error.response?.data?.msg 
              || error.response?.data?.message 
              || error.message 
              || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç '
```

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. ç¡®ä¿åç«¯æ­£åœ¨è¿è¡Œ

```bash
cd D:\å¥èº«æˆ¿é¢„çº¦å°ç¨‹åº\springboot
mvn spring-boot:run
```

**éªŒè¯**ï¼šè®¿é—® http://localhost:8888/doc.html èƒ½çœ‹åˆ°APIæ–‡æ¡£

### 2. å¯åŠ¨å‰ç«¯

```bash
cd D:\å¥èº«æˆ¿é¢„çº¦å°ç¨‹åº\vue3\coach
npm run dev
```

### 3. æ‰“å¼€æµè§ˆå™¨æµ‹è¯•

1. è®¿é—®å‰ç«¯åœ°å€ï¼ˆé€šå¸¸æ˜¯ http://localhost:5173ï¼‰
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Console æ ‡ç­¾
3. è¾“å…¥æµ‹è¯•è´¦å·ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`123456`
4. ç‚¹å‡»ç™»å½•

### 4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š

```
å¼€å§‹ç™»å½•ï¼Œè¯·æ±‚æ•°æ®ï¼š {username: 'admin', password: '123456'}
å“åº”æ‹¦æˆªå™¨ - åŸå§‹å“åº”ï¼š {data: {...}, status: 200, ...}
å“åº”æ‹¦æˆªå™¨ - å“åº”æ•°æ®ï¼š {code: "200", msg: "ç™»å½•æˆåŠŸ", data: {...}}
å“åº”æ‹¦æˆªå™¨ - è¿”å›æ•°æ®ï¼š {userInfo: {...}, token: "...", roleType: "ADMIN"}
ç™»å½•å“åº”ï¼š {userInfo: {...}, token: "...", roleType: "ADMIN"}
âœ… ç™»å½•æˆåŠŸï¼è·³è½¬åˆ° Dashboard
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
    â†“
å‰ç«¯: POST /api/user/login
    â†“
åç«¯: UserController.login()
    â†“
éªŒè¯ç”¨æˆ·åå¯†ç  (BCrypt)
    â†“
ç”Ÿæˆ JWT Token
    â†“
è¿”å›: {
  code: "200",           â† å­—ç¬¦ä¸²ç±»å‹
  msg: "ç™»å½•æˆåŠŸ",
  data: {
    userInfo: {...},     â† ç”¨æˆ·ä¿¡æ¯åœ¨è¿™é‡Œ
    token: "...",
    roleType: "ADMIN"
  }
}
    â†“
å‰ç«¯: request.js æ‹¦æˆªå™¨
    â†“
åˆ¤æ–­: code === "200" æˆ– 200 ?
    â†“ YES
è¿”å›: data.data (userInfo + token)
    â†“
Login.vue: ä¿å­˜åˆ° Store
    â†“
è·³è½¬åˆ° Dashboard
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å®Œæ•´çš„å“åº”æ•°æ®

åœ¨æµè§ˆå™¨Consoleä¸­ï¼Œä½ ä¼šçœ‹åˆ°è¯¦ç»†çš„æ—¥å¿—ï¼š

```javascript
// 1. è¯·æ±‚æ•°æ®
å¼€å§‹ç™»å½•ï¼Œè¯·æ±‚æ•°æ®ï¼š {username: "admin", password: "123456"}

// 2. åŸå§‹HTTPå“åº”
å“åº”æ‹¦æˆªå™¨ - åŸå§‹å“åº”ï¼š {
  data: {code: "200", msg: "ç™»å½•æˆåŠŸ", data: {...}},
  status: 200,
  statusText: "OK",
  headers: {...},
  config: {...}
}

// 3. ä¸šåŠ¡æ•°æ®
å“åº”æ‹¦æˆªå™¨ - å“åº”æ•°æ®ï¼š {
  code: "200",
  msg: "ç™»å½•æˆåŠŸ",
  data: {
    userInfo: {...},
    token: "...",
    roleType: "ADMIN"
  }
}

// 4. æ‹¦æˆªå™¨å¤„ç†åçš„æ•°æ®
å“åº”æ‹¦æˆªå™¨ - è¿”å›æ•°æ®ï¼š {
  userInfo: {...},
  token: "...",
  roleType: "ADMIN"
}

// 5. Login.vue æ”¶åˆ°çš„æ•°æ®
ç™»å½•å“åº”ï¼š {
  userInfo: {...},
  token: "...",
  roleType: "ADMIN"
}
```

### å¸¸è§é”™è¯¯æ’æŸ¥

#### é”™è¯¯1ï¼šä»ç„¶æç¤º "Error: ç™»å½•æˆåŠŸ"
- **åŸå› **ï¼šå‰ç«¯ä»£ç æ²¡æœ‰æ›´æ–°
- **è§£å†³**ï¼šé‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨ (Ctrl+C ç„¶åé‡æ–° `npm run dev`)

#### é”™è¯¯2ï¼šæç¤º "ç”¨æˆ·ä¸å­˜åœ¨"
- **åŸå› **ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥æˆ–ç”¨æˆ·ä¸å­˜åœ¨
- **è§£å†³**ï¼š
  ```sql
  -- åœ¨MySQLä¸­æ‰§è¡Œ
  USE gym;
  SELECT * FROM user WHERE username = 'admin';
  ```

#### é”™è¯¯3ï¼šæç¤º "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
- **åŸå› **ï¼šå¯†ç ä¸æ­£ç¡®
- **è§£å†³**ï¼šæ‰§è¡Œ `fix_login_password.sql` é‡ç½®å¯†ç 

#### é”™è¯¯4ï¼šç½‘ç»œé”™è¯¯
- **åŸå› **ï¼šåç«¯æœªå¯åŠ¨æˆ–ç«¯å£ä¸å¯¹
- **è§£å†³**ï¼š
  1. æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œåœ¨ 8888 ç«¯å£
  2. è®¿é—® http://localhost:8888/doc.html éªŒè¯

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### BCrypt å¯†ç éªŒè¯

```java
// åç«¯éªŒè¯é€»è¾‘
String inputPassword = "123456";
String storedHash = "$2a$10$0EB8hAzCT25cUhNeXDOhkujD./0TYjjiENnpirImJg4q4MeE/pKPa";

// BCrypt ä¼šè‡ªåŠ¨å¤„ç†ç›å€¼
boolean isMatch = passwordEncoder.matches(inputPassword, storedHash);
// â†’ true (å¯†ç æ­£ç¡®)
```

### JWT Token ç»“æ„

```
eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsInVzZXJJZCI6MSwidXNlclR5cGUiOiJBRE1JTiIsImlhdCI6MTY5OTk5OTk5OSwiZXhwIjoxNzAwMDg2Mzk5fQ.signature
â”‚                      â”‚                                                                                                          â”‚
â”‚                      â”‚                                                                                                          â”‚
Header                 Payload                                                                                                   Signature
(ç®—æ³•ä¿¡æ¯)              (ç”¨æˆ·ä¿¡æ¯ï¼šuserId, username, userType, è¿‡æœŸæ—¶é—´)                                                              (ç­¾å)
```

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] `request.js` å“åº”æ‹¦æˆªå™¨æ”¯æŒå­—ç¬¦ä¸²ç±»å‹çš„ code
- [x] `request.js` é”™è¯¯æ¶ˆæ¯å­—æ®µé€‚é…ï¼ˆmsg + messageï¼‰
- [x] `Login.vue` ä» `userInfo` è·å–ç”¨æˆ·æ•°æ®
- [x] `Login.vue` ä½¿ç”¨ `nickname` å­—æ®µ
- [x] æ·»åŠ è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—
- [x] æµ‹è¯•è´¦å·æç¤ºæ›´æ–°

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-12-11  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**ï¼šå¾…æµ‹è¯•

è¯·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æµ‹è¯•ï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜è¯·æä¾›æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—ï¼ğŸš€
